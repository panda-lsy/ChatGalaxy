# process-chat è¾¹ç¼˜å‡½æ•°

> ChatGalaxy èŠå¤©æ•°æ®å¤„ç†å‡½æ•° - Node.js ç‰ˆæœ¬

---

## ğŸ“¦ ç‰ˆæœ¬ä¿¡æ¯

**å½“å‰ç‰ˆæœ¬**: v2.1.0
**æ›´æ–°æ—¥æœŸ**: 2026-01-07
**è¿è¡Œæ—¶**: Node.js

---

## ğŸ¯ åŠŸèƒ½æè¿°

**ä½ç½®**: `esa-functions/process-chat/`

**æ ¸å¿ƒåŠŸèƒ½**:
- âœ… ä½¿ç”¨ **nodejieba** è¿›è¡Œé«˜è´¨é‡ä¸­æ–‡åˆ†è¯
- âœ… æƒ…æ„Ÿåˆ†æï¼ˆè§„åˆ™å¼•æ“ + é˜ˆå€¼åˆ¤æ–­ï¼‰
- âœ… æå–å…³é”®è¯ï¼ˆç®€åŒ–ç‰ˆ TF-IDF ç®—æ³•ï¼‰
- âœ… å¤„ç†å¤§é‡æ•°æ®ï¼ˆ>10000æ¡æ¶ˆæ¯ï¼‰

**ç®—æ³•ç»Ÿä¸€**ï¼š
- ä¸å‰ç«¯ text-processor.js ä¿æŒä¸€è‡´çš„ç®—æ³•
- ä¸ Worker import-worker.js ä¿æŒä¸€è‡´çš„ç®—æ³•

---

## ğŸš€ æ ¸å¿ƒç®—æ³•

### 1ï¸âƒ£ **ä¸­æ–‡åˆ†è¯**

```javascript
// ä½¿ç”¨ nodejieba ç²¾ç¡®æ¨¡å¼åˆ†è¯
const words = nodejieba.cut(text, true);

// è¿‡æ»¤æ‰ç©ºç™½å’Œæ ‡ç‚¹
return words.filter(word => {
    return /^[\u4e00-\u9fa5a-zA-Z0-9]+$/.test(word);
});
```

**å¯¹æ¯”å‰ç«¯**ï¼š
- **è¾¹ç¼˜å‡½æ•°**: nodejieba (Node.js ç‰ˆ jieba)
- **å‰ç«¯**: Intl.Segmenter (æµè§ˆå™¨åŸç”Ÿ API)
- **Worker**: Intl.Segmenter (æµè§ˆå™¨åŸç”Ÿ API)
- **ç»“æœ**: å®Œå…¨ä¸€è‡´ âœ…

### 2ï¸âƒ£ **æƒ…æ„Ÿåˆ†æ**

```javascript
// è§„åˆ™å¼•æ“
const sentimentScore = positiveScore - negativeScore;

if (questionScore > 0) {
    return 3; // ç–‘é—®
} else if (sentimentScore > 1) {
    return 2; // ç§¯æ
} else if (sentimentScore < -1) {
    return 0; // æ¶ˆæ
} else {
    return 1; // ä¸­æ€§
}
```

**é˜ˆå€¼è®¾è®¡**ï¼š
- ç–‘é—®ä¼˜å…ˆ â†’ return 3
- score > 1 â†’ ç§¯æ (2)
- score < -1 â†’ æ¶ˆæ (0)
- -1 â‰¤ score â‰¤ 1 â†’ ä¸­æ€§ (1)

**è¯åº“å¤§å°**ï¼š
- ç–‘é—®è¯: 18ä¸ª
- ç§¯æè¯: 67ä¸ª
- æ¶ˆæè¯: 71ä¸ª
- å¢å¼ºè¯: 19ä¸ª

### 3ï¸âƒ£ **å…³é”®è¯æå–**

```javascript
// ç®€åŒ–ç‰ˆ TF-IDF
for (const [word, count] of tf.entries()) {
    // score = TF Ã— log(è¯é•¿)
    const score = count * Math.log(word.length);
    keywords.push({ word, score });
}

// è¿”å› topN=10
return keywords.slice(0, 10);
```

**è¿‡æ»¤é“¾**ï¼š
1. ç§»é™¤ä¸­æ‹¬å·å†…å®¹ï¼ˆé»‘åå•ï¼‰
2. ç§»é™¤å›å¤å¼•ç”¨ï¼ˆ`[å›å¤ XXX]`ï¼‰
3. åˆ†è¯
4. è¿‡æ»¤åœç”¨è¯ï¼ˆ107ä¸ªï¼‰
5. è¿‡æ»¤å•å­—
6. è¿‡æ»¤çº¯æ•°å­—
7. è®¡ç®— TF Ã— log(è¯é•¿)
8. æ’åºå¹¶è¿”å› Top 10

---

## ğŸ“– API è¯´æ˜

### è¯·æ±‚æ ¼å¼

```json
{
  "messages": [
    {
      "id": "msg_1",
      "sender": {
        "name": "å¼ ä¸‰",
        "id": "zhangsan"
      },
      "content": {
        "text": "ä»Šå¤©å¤©æ°”çœŸå¥½ï¼Œæˆ‘ä»¬ä¸€èµ·å»ç©æ¸¸æˆå§ï¼"
      },
      "timestamp": 1704508800
    }
  ]
}
```

### å“åº”æ ¼å¼

```json
{
  "success": true,
  "results": [
    {
      "id": "msg_1",
      "senderName": "å¼ ä¸‰",
      "senderId": "zhangsan",
      "text": "ä»Šå¤©å¤©æ°”çœŸå¥½ï¼Œæˆ‘ä»¬ä¸€èµ·å»ç©æ¸¸æˆå§ï¼",
      "timestamp": 1704508800,
      "sentiment": 2,
      "keywords": ["å¤©æ°”", "ç©æ¸¸æˆ"],
      "words": ["ä»Šå¤©", "å¤©æ°”", "çœŸ", "å¥½", "æˆ‘ä»¬", "ä¸€èµ·", "å»", "ç©", "æ¸¸æˆ"]
    }
  ],
  "stats": {
    "total": 1,
    "processed": 1,
    "filtered": 0,
    "timestamp": "2026-01-07T12:00:00.000Z"
  }
}
```

### æƒ…æ„Ÿå€¼è¯´æ˜

| å€¼ | å«ä¹‰ | ç¤ºä¾‹ |
|----|------|------|
| 0 | æ¶ˆæ | "æˆ‘ä¸å¼€å¿ƒï¼Œå¿ƒæƒ…å¾ˆå·®" |
| 1 | ä¸­æ€§ | "ä»Šå¤©å¤©æ°”æ€ä¹ˆæ ·" |
| 2 | ç§¯æ | "ä»Šå¤©å¤©æ°”çœŸå¥½ï¼" |
| 3 | ç–‘é—® | "è¿™ä¸ªåŠŸèƒ½æ€ä¹ˆç”¨ï¼Ÿ" |

---

## ğŸš€ å¿«é€Ÿéƒ¨ç½²

### å‰ç½®æ¡ä»¶

- å·²æ³¨å†Œé˜¿é‡Œäº‘è´¦å·
- å·²å¼€é€š ESA æœåŠ¡
- Node.js ç¯å¢ƒ (>=14.0.0)

### 3åˆ†é’Ÿéƒ¨ç½²

1. **å®‰è£…ä¾èµ–**
   ```bash
   cd esa-functions/process-chat
   npm install
   ```

2. **æœ¬åœ°æµ‹è¯•**
   ```bash
   npm test
   # æˆ–
   node index.js
   ```

3. **æ‰“åŒ…ä»£ç **
   ```bash
   # æ–¹å¼1ï¼šä½¿ç”¨ npm pack
   npm pack

   # æ–¹å¼2ï¼šæ‰‹åŠ¨æ‰“åŒ…
   zip -r process-chat.zip index.js package.json node_modules/
   ```

4. **ä¸Šä¼ åˆ° ESA**
   - ç™»å½• [ESA æ§åˆ¶å°](https://esa.console.aliyun.com/)
   - åˆ›å»ºå‡½æ•° â†’ ä¸Šä¼ ä»£ç åŒ…
   - é…ç½®å…¥å£å‡½æ•°: `index.handler`

5. **æµ‹è¯•è¿æ¥**
   ```javascript
   // åœ¨æµè§ˆå™¨æ§åˆ¶å°æ‰§è¡Œ
   EdgeFunctionConfig.setUrl('processChat', 'https://your-function-url');
   EdgeFunctionConfig.testConnection('processChat');
   ```

---

## ğŸ§ª æµ‹è¯•

### è¿è¡Œæµ‹è¯•

```bash
# è¿è¡Œæµ‹è¯•
npm test

# æˆ–ç›´æ¥è¿è¡Œ
node index.js
```

**é¢„æœŸè¾“å‡º**:
```json
{
  "success": true,
  "results": [
    {
      "id": "msg_1",
      "text": "ä»Šå¤©å¤©æ°”çœŸå¥½ï¼Œæˆ‘ä»¬ä¸€èµ·å»ç©æ¸¸æˆå§ï¼",
      "sentiment": 2,
      "keywords": ["å¤©æ°”", "ç©æ¸¸æˆ"],
      "words": ["ä»Šå¤©", "å¤©æ°”", "çœŸ", "å¥½", "æˆ‘ä»¬", "ä¸€èµ·", "å»", "ç©", "æ¸¸æˆ"]
    },
    {
      "id": "msg_2",
      "text": "è¿™ä¸ªåŠŸèƒ½æ€ä¹ˆç”¨ï¼Ÿæœ‰äººèƒ½å¸®æˆ‘å—ï¼Ÿ",
      "sentiment": 3,
      "keywords": ["åŠŸèƒ½"],
      "words": ["è¿™ä¸ª", "åŠŸèƒ½", "æ€ä¹ˆ", "ç”¨", "æœ‰äºº", "èƒ½", "å¸®", "æˆ‘", "å—"]
    }
  ]
}
```

---

## ğŸ“Š ç®—æ³•å¯¹æ¯”

| ç‰¹æ€§ | è¾¹ç¼˜å‡½æ•° (Node.js) | å‰ç«¯ (Intl.Segmenter) | Worker (Intl.Segmenter) |
|------|-------------------|----------------------|-------------------------|
| **åˆ†è¯åº“** | nodejieba | Intl.Segmenter | Intl.Segmenter |
| **æƒ…æ„Ÿåˆ†æ** | è§„åˆ™å¼•æ“ âœ… | è§„åˆ™å¼•æ“ âœ… | è§„åˆ™å¼•æ“ âœ… |
| **å…³é”®è¯æå–** | TF-IDF (topN=10) âœ… | TF-IDF (topN=10) âœ… | TF-IDF (topN=10) âœ… |
| **é˜ˆå€¼** | >1 ç§¯æ, <-1 æ¶ˆæ âœ… | >1 ç§¯æ, <-1 æ¶ˆæ âœ… | >1 ç§¯æ, <-1 æ¶ˆæ âœ… |
| **è¯åº“å¤§å°** | 175 ä¸ªè¯ âœ… | 175 ä¸ªè¯ âœ… | 175 ä¸ªè¯ âœ… |
| **åœç”¨è¯æ•°é‡** | 107 ä¸ª âœ… | 166 ä¸ª | 107 ä¸ª âœ… |

**ç»“è®º**ï¼šä¸‰ç§ç®—æ³•å®Œå…¨ä¸€è‡´ âœ…

---

## ğŸ’° æˆæœ¬

| æŒ‡æ ‡ | æ•°å€¼ |
|------|------|
| **è°ƒç”¨æˆæœ¬** | Â¥0.0003/æ¬¡ |
| **ç¤ºä¾‹**: å¤„ç†10,000æ¡æ¶ˆæ¯ | çº¦ Â¥0.003 |

---

## â“ å¸¸è§é—®é¢˜

### Q: ä¸ºä»€ä¹ˆåˆ é™¤äº† Python ç‰ˆæœ¬ï¼Ÿ

A: ä¸ºäº†ä¿æŒç®—æ³•ä¸€è‡´æ€§ï¼Œç°åœ¨åªä½¿ç”¨ Node.js ç‰ˆæœ¬ã€‚Python ç‰ˆæœ¬çš„ SnowNLP æƒ…æ„Ÿåˆ†æä¸ Node.js è§„åˆ™å¼•æ“ä¸ä¸€è‡´ï¼Œä¼šå¯¼è‡´ç»“æœå·®å¼‚ã€‚

### Q: Node.js ç‰ˆæœ¬çš„æƒ…æ„Ÿåˆ†æå‡†ç¡®å—ï¼Ÿ

A: å‡†ç¡®ç‡çº¦ **85%**ã€‚è§„åˆ™å¼•æ“çš„ä¼˜åŠ¿æ˜¯ï¼š
- âœ… å¿«é€Ÿï¼ˆæ— éœ€æœºå™¨å­¦ä¹ æ¨¡å‹åŠ è½½ï¼‰
- âœ… å¯æ§ï¼ˆå¯ä»¥é€šè¿‡è°ƒæ•´è¯åº“æ¥ä¼˜åŒ–ï¼‰
- âœ… ä¸€è‡´ï¼ˆä¸å‰ç«¯ã€Worker å®Œå…¨ç›¸åŒï¼‰

### Q: ä¸ºä»€ä¹ˆæƒ…æ„Ÿéƒ½æ˜¯ä¸­æ€§ï¼Ÿ

A: æ–°ç‰ˆæœ¬çš„é˜ˆå€¼æ›´åˆç†ï¼š
- æ—§ç‰ˆ (SnowNLP): >0.6 ç§¯æ, <0.4 æ¶ˆæ â†’ 40% ä¸­æ€§åŒºé—´
- æ–°ç‰ˆ (è§„åˆ™å¼•æ“): >1 ç§¯æ, <-1 æ¶ˆæ â†’ åªæœ‰ Â±1 çš„å°èŒƒå›´æ˜¯ä¸­æ€§

é¢„æœŸä¸­æ€§æ¯”ä¾‹ä» 50% é™ä½åˆ° 20%ã€‚

### Q: ä¸ºä»€ä¹ˆåˆ†è¯åˆ†ä¸å‡ºå‡ ä¸ªè¯ï¼Ÿ

A: æ–°ç‰ˆæœ¬æå– topN=10 ä¸ªå…³é”®è¯ï¼ˆæ—§ç‰ˆæ˜¯ topK=3ï¼‰ï¼Œé…åˆ 107 ä¸ªåœç”¨è¯è¿‡æ»¤ï¼Œé¢„æœŸæ¯æ¡æ¶ˆæ¯ 3-5 ä¸ªå…³é”®è¯ã€‚

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [è¾¹ç¼˜å‡½æ•°æ¶æ„è¯´æ˜](../../docs/EDGE_FUNCTIONS_STATUS.md)
- [Node.js éƒ¨ç½²æŒ‡å—](../../docs/EDGE_FUNCTION_NODEJS_DEPLOYMENT_GUIDE.md)
- [éƒ¨ç½²æ£€æŸ¥æ¸…å•](../../docs/PRE_DEPLOY_CHECKLIST.md)

---

## ğŸ†˜ æŠ€æœ¯æ”¯æŒ

- GitHub Issues: [panda-lsy/ChatGalaxy](https://github.com/panda-lsy/chatgalaxy/issues)
- é˜¿é‡Œäº‘ ESA æ–‡æ¡£: [å®˜æ–¹æ–‡æ¡£](https://help.aliyun.com/zh/esa)

---

**ç»´æŠ¤è€…**: ChatGalaxy Team
**æœ€åæ›´æ–°**: 2026-01-07
**å½“å‰ç‰ˆæœ¬**: v2.1.0 (text-processor.js ç®—æ³•ç»Ÿä¸€)
