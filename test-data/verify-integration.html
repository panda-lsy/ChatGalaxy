<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phase 3.1 é›†æˆéªŒè¯ - ChatGalaxy</title>

    <!-- RemixIcon -->
    <link href="../js/lib/remixicon/remixicon.css" rel="stylesheet">

    <!-- æ ·å¼ -->
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/data-manager.css">

    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-color, #1a1a2e);
            color: var(--text-color, #b8c1ec);
        }

        .test-container {
            max-width: 1000px;
            margin: 40px auto;
            padding: 20px;
        }

        .test-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .test-header h1 {
            color: var(--accent-color, #667eea);
            margin-bottom: 8px;
        }

        .test-section {
            background: var(--bg-secondary, #16213e);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
        }

        .test-section h2 {
            margin-top: 0;
            color: var(--text-color, #b8c1ec);
            border-bottom: 1px solid var(--border-color, rgba(255, 255, 255, 0.1));
            padding-bottom: 12px;
        }

        .test-btn {
            padding: 12px 24px;
            margin: 8px 8px 8px 0;
            font-size: 14px;
            font-weight: 600;
            color: #ffffff;
            background: var(--accent-color, #667eea);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .test-btn:hover {
            background: var(--accent-hover, #5568d3);
            transform: translateY(-2px);
        }

        .test-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .test-btn.secondary {
            background: rgba(255, 255, 255, 0.1);
        }

        .test-result {
            margin-top: 16px;
            padding: 16px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            color: var(--text-color, #b8c1ec);
            background: var(--bg-color, #1a1a2e);
            border: 1px solid var(--border-color, rgba(255, 255, 255, 0.1));
            border-radius: 6px;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 400px;
            overflow-y: auto;
        }

        .test-result.error {
            border-color: var(--danger-color, #ef4444);
            color: var(--danger-color, #ef4444);
        }

        .test-result.success {
            border-color: var(--success-color, #10b981);
            color: var(--success-color, #10b981);
        }

        .status-badge {
            display: inline-block;
            padding: 6px 16px;
            margin: 8px 0;
            font-size: 13px;
            font-weight: 600;
            border-radius: 16px;
        }

        .status-badge.ready {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .status-badge.not-ready {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .checklist {
            list-style: none;
            padding: 0;
            margin: 16px 0;
        }

        .checklist li {
            padding: 8px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checklist li i {
            font-size: 18px;
        }

        .checklist li i.ri-checkbox-circle-fill {
            color: #10b981;
        }

        .checklist li i.ri-close-circle-fill {
            color: #ef4444;
        }

        .checklist li i.ri-loader-4-line {
            color: #667eea;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .info-box {
            background: rgba(102, 126, 234, 0.1);
            border-left: 4px solid #667eea;
            padding: 12px 16px;
            margin: 16px 0;
            border-radius: 4px;
        }

        .info-box p {
            margin: 4px 0;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <!-- é¡µå¤´ -->
        <div class="test-header">
            <h1>ğŸ§ª Phase 3.1 é›†æˆéªŒè¯</h1>
            <p>éªŒè¯è¾¹ç¼˜å‡½æ•°é›†æˆçš„ä»£ç æ­£ç¡®æ€§</p>
            <div id="statusBadge" class="status-badge not-ready">
                <i class="ri-close-circle-fill"></i> ç­‰å¾…æµ‹è¯•
            </div>
        </div>

        <!-- æµ‹è¯•è¯´æ˜ -->
        <div class="test-section">
            <h2>ğŸ“‹ æµ‹è¯•è¯´æ˜</h2>
            <p style="color: var(--text-secondary, rgba(184, 193, 236, 0.7));">
                æœ¬é¡µé¢å°†è‡ªåŠ¨éªŒè¯ Phase 3.1 çš„ä»£ç é›†æˆï¼ŒåŒ…æ‹¬ï¼š
            </p>
            <ul class="checklist">
                <li><i class="ri-checkbox-circle-line"></i> EdgeFunctionConfig é…ç½®ç®¡ç†å™¨</li>
                <li><i class="ri-checkbox-circle-line"></i> data-import.js è¾¹ç¼˜å‡½æ•°é›†æˆ</li>
                <li><i class="ri-checkbox-circle-line"></i> data-manager.html æ¨¡å¼é€‰æ‹©å™¨UI</li>
                <li><i class="ri-checkbox-circle-line"></i> data-manager-ui.js äº‹ä»¶å¤„ç†</li>
                <li><i class="ri-checkbox-circle-line"></i> äº‹ä»¶ç›‘å¬å™¨é…ç½®</li>
            </ul>
            <div class="info-box">
                <p><i class="ri-information-line"></i> <strong>æç¤º</strong></p>
                <p>æµ‹è¯•ä¼šåœ¨é¡µé¢åŠ è½½åè‡ªåŠ¨è¿è¡Œï¼Œæˆ–ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ‰‹åŠ¨è¿è¡Œ</p>
            </div>
        </div>

        <!-- æµ‹è¯•æ§åˆ¶ -->
        <div class="test-section">
            <h2>ğŸš€ æµ‹è¯•æ§åˆ¶</h2>
            <button class="test-btn" id="runTestBtn" onclick="runVerification()">
                <i class="ri-play-line"></i> è¿è¡ŒéªŒè¯æµ‹è¯•
            </button>
            <button class="test-btn secondary" onclick="clearConsole()">
                <i class="ri-delete-bin-line"></i> æ¸…ç©ºæ§åˆ¶å°
            </button>
            <button class="test-btn secondary" onclick="location.reload()">
                <i class="ri-refresh-line"></i> åˆ·æ–°é¡µé¢
            </button>
            <div id="testResult" class="test-result" style="display: none;"></div>
        </div>

        <!-- æµ‹è¯•ç»“æœ -->
        <div class="test-section">
            <h2>ğŸ“Š æµ‹è¯•ç»“æœ</h2>
            <div id="testSummary"></div>
        </div>

        <!-- å¿«é€Ÿæµ‹è¯• -->
        <div class="test-section">
            <h2>âš¡ å¿«é€ŸåŠŸèƒ½æµ‹è¯•</h2>
            <p style="color: var(--text-secondary, rgba(184, 193, 236, 0.7));">
                å¿«é€Ÿæµ‹è¯•è¾¹ç¼˜å‡½æ•°é…ç½®çš„æ ¸å¿ƒåŠŸèƒ½
            </p>
            <button class="test-btn" onclick="testConfigManager()">
                <i class="ri-settings-3-line"></i> æµ‹è¯•é…ç½®ç®¡ç†å™¨
            </button>
            <button class="test-btn" onclick="testModeSelector()">
                <i class="ri-toggle-line"></i> æµ‹è¯•æ¨¡å¼é€‰æ‹©å™¨
            </button>
            <button class="test-btn" onclick="simulateEdgeFunction()">
                <i class="ri-cloud-line"></i> æ¨¡æ‹Ÿè¾¹ç¼˜å‡½æ•°è°ƒç”¨
            </button>
            <div id="quickTestResult" class="test-result" style="display: none;"></div>
        </div>
    </div>

    <!-- åŠ è½½æ‰€æœ‰å¿…è¦çš„è„šæœ¬ -->
    <script src="../js/config.js"></script>
    <script src="../js/utils/logger.js"></script>
    <script src="../js/data/data-manager.js"></script>
    <script src="../js/data/data-batch-operations.js"></script>
    <script src="../js/processors/text-processor.js"></script>
    <script src="../js/edge-function-config.js"></script>
    <script src="../js/data-import.js"></script>
    <script src="../js/data-manager-ui.js"></script>

    <!-- åŠ è½½éªŒè¯è„šæœ¬ -->
    <script src="verify-phase3-integration.js"></script>

    <script>
        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨è¿è¡Œæµ‹è¯•
        document.addEventListener('DOMContentLoaded', () => {
            updateStatus('ready', 'å°±ç»ª');

            // å»¶è¿Ÿè‡ªåŠ¨è¿è¡Œæµ‹è¯•ï¼ˆ2ç§’åï¼‰
            setTimeout(() => {
                if (window.verifyPhase3Integration) {
                    console.log('%cğŸš€ è‡ªåŠ¨è¿è¡ŒéªŒè¯æµ‹è¯•...', 'color: #667eea; font-weight: bold;');
                    runVerification();
                }
            }, 2000);
        });

        // è¿è¡ŒéªŒè¯æµ‹è¯•
        function runVerification() {
            const btn = document.getElementById('runTestBtn');
            const resultDiv = document.getElementById('testResult');
            const summaryDiv = document.getElementById('testSummary');
            const statusBadge = document.getElementById('statusBadge');

            btn.disabled = true;
            btn.innerHTML = '<i class="ri-loader-4-line ri-spin"></i> æµ‹è¯•ä¸­...';
            resultDiv.style.display = 'block';
            resultDiv.textContent = 'â³ æ­£åœ¨è¿è¡ŒéªŒè¯æµ‹è¯•...\n\nè¯·æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°ï¼ˆF12ï¼‰æŸ¥çœ‹è¯¦ç»†ç»“æœã€‚';
            updateStatus('testing', 'æµ‹è¯•ä¸­...');

            // è¿è¡Œæµ‹è¯•
            if (window.verifyPhase3Integration) {
                setTimeout(() => {
                    const result = window.verifyPhase3Integration();

                    // æ˜¾ç¤ºç»“æœ
                    const summaryHTML = `
                        <div style="padding: 16px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                            <h3 style="margin-top: 0; color: var(--accent-color);">
                                æµ‹è¯•å®Œæˆï¼
                            </h3>
                            <p style="font-size: 16px;">
                                æ€»è®¡: <strong>${result.total}</strong> ä¸ªæµ‹è¯• |
                                é€šè¿‡: <strong style="color: #10b981;">${result.passed}</strong> ä¸ª |
                                å¤±è´¥: <strong style="color: #ef4444;">${result.failed}</strong> ä¸ª
                            </p>
                            <p style="font-size: 20px; font-weight: bold; color: ${result.passRate === 100 ? '#10b981' : result.passRate >= 80 ? '#f59e0b' : '#ef4444'};">
                                é€šè¿‡ç‡: ${result.passRate}%
                            </p>
                            ${result.passRate === 100 ? '<p style="color: #10b981;">ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼</p>' : ''}
                        </div>
                    `;

                    summaryDiv.innerHTML = summaryHTML;

                    resultDiv.textContent = `âœ… æµ‹è¯•å®Œæˆï¼\n\næ€»è®¡: ${result.total} ä¸ª\né€šè¿‡: ${result.passed} ä¸ª\nå¤±è´¥: ${result.failed} ä¸ª\né€šè¿‡ç‡: ${result.passRate}%\n\nè¯¦ç»†ç»“æœè¯·æŸ¥çœ‹æ§åˆ¶å°ã€‚`;
                    resultDiv.className = 'test-result success';

                    btn.disabled = false;
                    btn.innerHTML = '<i class="ri-refresh-line"></i> é‡æ–°è¿è¡Œ';

                    const status = result.passRate === 100 ? 'all-pass' : result.passRate >= 80 ? 'partial-pass' : 'failed';
                    const statusText = result.passRate === 100 ? 'å…¨éƒ¨é€šè¿‡ âœ…' : result.passRate >= 80 ? 'éƒ¨åˆ†é€šè¿‡ âš ï¸' : 'æµ‹è¯•å¤±è´¥ âŒ';
                    updateStatus(status, statusText);

                }, 500);
            } else {
                resultDiv.textContent = 'âŒ éªŒè¯è„šæœ¬æœªåŠ è½½';
                resultDiv.className = 'test-result error';
                btn.disabled = false;
                btn.innerHTML = '<i class="ri-play-line"></i> è¿è¡ŒéªŒè¯æµ‹è¯•';
            }
        }

        // æµ‹è¯•é…ç½®ç®¡ç†å™¨
        function testConfigManager() {
            const resultDiv = document.getElementById('quickTestResult');
            resultDiv.style.display = 'block';

            try {
                // æµ‹è¯• 1ï¼šè®¾ç½® URL
                window.EdgeFunctionConfig.setUrl('processChat', 'https://test.example.com/process');
                const getUrl = window.EdgeFunctionConfig.getUrl('processChat');

                // æµ‹è¯• 2ï¼šæ£€æŸ¥å¯ç”¨æ€§
                const isAvailable = window.EdgeFunctionConfig.isAvailable('processChat');

                // æµ‹è¯• 3ï¼šæ¸…é™¤é…ç½®
                window.EdgeFunctionConfig.clearUrls();
                const afterClear = window.EdgeFunctionConfig.isAvailable('processChat');

                // æ˜¾ç¤ºç»“æœ
                const results = [
                    `âœ… URL è®¾ç½®: ${getUrl === 'https://test.example.com/process' ? 'é€šè¿‡' : 'å¤±è´¥'}`,
                    `âœ… å¯ç”¨æ€§æ£€æŸ¥: ${isAvailable ? 'é€šè¿‡' : 'å¤±è´¥'}`,
                    `âœ… é…ç½®æ¸…é™¤: ${!afterClear ? 'é€šè¿‡' : 'å¤±è´¥'}`
                ];

                resultDiv.textContent = 'é…ç½®ç®¡ç†å™¨æµ‹è¯•ç»“æœ:\n\n' + results.join('\n');
                resultDiv.className = 'test-result success';

            } catch (error) {
                resultDiv.textContent = 'âŒ æµ‹è¯•å¤±è´¥: ' + error.message;
                resultDiv.className = 'test-result error';
            }
        }

        // æµ‹è¯•æ¨¡å¼é€‰æ‹©å™¨
        function testModeSelector() {
            const resultDiv = document.getElementById('quickTestResult');
            resultDiv.style.display = 'block';

            try {
                // è·å–æ¨¡å¼é€‰é¡¹
                const fastMode = document.querySelector('input[name="processingMode"][value="fast"]');
                const preciseMode = document.querySelector('input[name="processingMode"][value="precise"]');

                if (!fastMode || !preciseMode) {
                    throw new Error('æ¨¡å¼é€‰æ‹©å™¨æœªæ‰¾åˆ°ï¼ˆè¯·ç¡®ä¿åœ¨ data-manager.html ä¸­è¿è¡Œï¼‰');
                }

                // æµ‹è¯•é»˜è®¤çŠ¶æ€
                const defaultFast = fastMode.checked;

                // æ¨¡æ‹Ÿåˆ‡æ¢
                preciseMode.click();
                const preciseSelected = preciseMode.checked;

                fastMode.click();
                const fastSelected = fastMode.checked;

                // æ˜¾ç¤ºç»“æœ
                const results = [
                    `âœ… å¿«é€Ÿæ¨¡å¼é€‰é¡¹: ${fastMode ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}`,
                    `âœ… ç²¾ç¡®æ¨¡å¼é€‰é¡¹: ${preciseMode ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}`,
                    `âœ… é»˜è®¤é€‰ä¸­å¿«é€Ÿ: ${defaultFast ? 'é€šè¿‡' : 'å¤±è´¥'}`,
                    `âœ… åˆ‡æ¢åˆ°ç²¾ç¡®æ¨¡å¼: ${preciseSelected ? 'é€šè¿‡' : 'å¤±è´¥'}`,
                    `âœ… åˆ‡æ¢å›å¿«é€Ÿæ¨¡å¼: ${fastSelected ? 'é€šè¿‡' : 'å¤±è´¥'}`
                ];

                resultDiv.textContent = 'æ¨¡å¼é€‰æ‹©å™¨æµ‹è¯•ç»“æœ:\n\n' + results.join('\n');
                resultDiv.className = 'test result success';

            } catch (error) {
                resultDiv.textContent = 'âŒ æµ‹è¯•å¤±è´¥: ' + error.message;
                resultDiv.className = 'test-result error';
            }
        }

        // æ¨¡æ‹Ÿè¾¹ç¼˜å‡½æ•°è°ƒç”¨
        function simulateEdgeFunction() {
            const resultDiv = document.getElementById('quickTestResult');
            resultDiv.style.display = 'block';
            resultDiv.textContent = 'â³ æ­£åœ¨æ¨¡æ‹Ÿè¾¹ç¼˜å‡½æ•°è°ƒç”¨...';
            resultDiv.className = 'test-result';

            // é…ç½®æ¨¡æ‹Ÿ URL
            window.EdgeFunctionConfig.setUrl('processChat', 'mock://edge-function');

            setTimeout(() => {
                // æ¨¡æ‹Ÿè°ƒç”¨
                const mockMessages = [
                    { id: 'test_1', senderName: 'å¼ ä¸‰', text: 'æµ‹è¯•æ¶ˆæ¯1', timestamp: Date.now() / 1000 },
                    { id: 'test_2', senderName: 'æå››', text: 'æµ‹è¯•æ¶ˆæ¯2', timestamp: Date.now() / 1000 }
                ];

                // æ¨¡æ‹Ÿè¿”å›ç»“æœ
                const mockResult = {
                    success: true,
                    results: [
                        { id: 'test_1', sentiment: 1, keywords: ['æµ‹è¯•', 'æ¶ˆæ¯'] },
                        { id: 'test_2', sentiment: 2, keywords: ['æµ‹è¯•', 'æ¶ˆæ¯'] }
                    ],
                    stats: { total: 2, processed: 2, failed: 0 }
                };

                resultDiv.textContent = 'âœ… æ¨¡æ‹Ÿè°ƒç”¨æˆåŠŸï¼\n\n' +
                    'è¯·æ±‚æ•°æ®:\n' + JSON.stringify({ messages: mockMessages }, null, 2) + '\n\n' +
                    'æ¨¡æ‹Ÿè¿”å›:\n' + JSON.stringify(mockResult, null, 2);
                resultDiv.className = 'test-result success';

            }, 1000);
        }

        // æ¸…ç©ºæ§åˆ¶å°
        function clearConsole() {
            console.clear();
            console.log('%cğŸ§¹ æ§åˆ¶å°å·²æ¸…ç©º', 'color: #667eea; font-weight: bold;');
        }

        // æ›´æ–°çŠ¶æ€å¾½ç« 
        function updateStatus(status, text) {
            const badge = document.getElementById('statusBadge');

            badge.className = 'status-badge';

            switch (status) {
                case 'ready':
                    badge.classList.add('ready');
                    badge.innerHTML = '<i class="ri-checkbox-circle-fill"></i> ' + text;
                    break;
                case 'testing':
                    badge.classList.add('not-ready');
                    badge.innerHTML = '<i class="ri-loader-4-line ri-spin"></i> ' + text;
                    break;
                case 'all-pass':
                    badge.classList.add('ready');
                    badge.innerHTML = '<i class="ri-checkbox-circle-fill"></i> ' + text;
                    break;
                case 'partial-pass':
                    badge.classList.add('not-ready');
                    badge.style.background = 'rgba(245, 158, 11, 0.2)';
                    badge.style.color = '#f59e0b';
                    badge.innerHTML = '<i class="ri-error-warning-line"></i> ' + text;
                    break;
                case 'failed':
                    badge.classList.add('not-ready');
                    badge.innerHTML = '<i class="ri-close-circle-fill"></i> ' + text;
                    break;
            }
        }
    </script>
</body>
</html>
