<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f1419">
    <title>数据管理器 - ChatGalaxy</title>
    <link href="js/lib/remixicon/remixicon.css" rel="stylesheet">
    <link rel="stylesheet" href="css/data-manager.css">
    <link rel="stylesheet" href="css/processing-mode-selector.css">
    <link rel="stylesheet" href="css/share-modal.css">
</head>
<body>
    <!-- 背景装饰 - 与主页面一致 -->
    <div class="bg-decoration">
        <div class="bg-circle circle-1"></div>
        <div class="bg-circle circle-2"></div>
        <div class="bg-circle circle-3"></div>
    </div>

    <!-- 主容器 -->
    <div class="manager-container">
        <!-- 头部 -->
        <header class="manager-header">
            <div class="header-content">
                <div class="header-left">
                    <button class="back-btn" onclick="window.location.href='index.html'" title="返回星系">
                        <i class="ri-arrow-go-back-line"></i>
                    </button>
                    <div class="header-title">
                        <h1><i class="ri-database-2-line"></i> 数据管理器</h1>
                        <p>管理您的聊天数据集</p>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="action-btn secondary" onclick="createNewDataset()">
                        <i class="ri-add-circle-line"></i>
                        <span>创建空数据集</span>
                    </button>
                    <button class="action-btn secondary" onclick="openImportShare()">
                        <i class="ri-download-cloud-line"></i>
                        <span>导入分享</span>
                    </button>
                    <button class="action-btn secondary" onclick="loadDemoDataset()">
                        <i class="ri-magic-line"></i>
                        <span>演示数据</span>
                    </button>
                    <button class="action-btn secondary" onclick="refreshDatasetList()">
                        <i class="ri-refresh-line"></i>
                        <span>刷新</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- 主内容区 -->
        <main class="manager-main">
            <!-- 导入面板 -->
            <section class="import-section">
                <div class="section-header" onclick="toggleImportPanel()">
                    <h2><i class="ri-upload-cloud-line"></i> 导入数据集</h2>
                    <button class="collapse-btn">
                        <i class="ri-arrow-down-s-line" id="import-panel-icon"></i>
                    </button>
                </div>

                <div class="import-content" id="import-panel-content">
                    <!-- 上传区域 -->
                    <div class="upload-zone" id="upload-zone">
                        <div class="upload-icon">
                            <i class="ri-cloud-upload-line"></i>
                        </div>
                        <div class="upload-text">拖拽JSON文件到此处，或点击选择</div>
                        <div class="upload-hint">支持最大10MB的JSON文件</div>
                        <input type="file" id="file-input" accept=".json" style="display: none;">
                    </div>

                    <!-- 文件信息 -->
                    <div class="file-info" id="file-info" style="display: none;">
                        <i class="ri-file-text-line"></i>
                        <span id="file-name"></span>
                    </div>

                    <!-- 验证警告 -->
                    <div class="validation-warnings" id="validation-warnings" style="display: none;">
                        <h4><i class="ri-alert-line"></i> 导入警告</h4>
                        <ul id="validation-warning-list"></ul>
                    </div>

                    <!-- 数据集表单 -->
                    <div class="dataset-form" id="dataset-form" style="display: none;">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">数据集名称 <span class="required">*</span></label>
                                <input type="text" id="dataset-name" class="form-input" placeholder="例如：我的聊天记录">
                            </div>

                            <div class="form-group">
                                <label class="form-label">主题颜色</label>
                                <div class="color-selector" id="color-selector">
                                    <div class="color-option selected" style="background: #3498db;" data-color="#3498db" onclick="selectColor(this)"></div>
                                    <div class="color-option" style="background: #10b981;" data-color="#10b981" onclick="selectColor(this)"></div>
                                    <div class="color-option" style="background: #f59e0b;" data-color="#f59e0b" onclick="selectColor(this)"></div>
                                    <div class="color-option" style="background: #ef4444;" data-color="#ef4444" onclick="selectColor(this)"></div>
                                    <div class="color-option" style="background: #8b5cf6;" data-color="#8b5cf6" onclick="selectColor(this)"></div>
                                    <div class="color-option" style="background: #ec4899;" data-color="#ec4899" onclick="selectColor(this)"></div>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">描述（可选）</label>
                            <textarea id="dataset-description" class="form-textarea" placeholder="简单描述这个数据集..." rows="3"></textarea>
                        </div>

                        <div class="form-group">
                            <label class="form-label">标签</label>
                            <div class="tag-selector" id="tag-selector">
                                <div class="tag-option" onclick="toggleTag(this)">游戏</div>
                                <div class="tag-option" onclick="toggleTag(this)">工作</div>
                                <div class="tag-option" onclick="toggleTag(this)">学习</div>
                                <div class="tag-option" onclick="toggleTag(this)">生活</div>
                                <div class="tag-option" onclick="toggleTag(this)">社交</div>
                                <div class="tag-option" onclick="toggleTag(this)">其他</div>
                            </div>
                        </div>

                        <!-- 处理模式选择 -->
                        <div class="form-group">
                            <label class="form-label">
                                处理模式
                                <span class="label-hint" title="选择数据处理方式">ⓘ</span>
                            </label>
                            <div class="processing-mode-selector">
                                <label class="mode-option">
                                    <input type="radio" name="processingMode" value="fast" checked>
                                    <div class="mode-card">
                                        <div class="mode-card-header">
                                            <div class="mode-icon">
                                                <i class="ri-flash-line"></i>
                                            </div>
                                            <div class="mode-title">
                                                <h3>快速模式</h3>
                                                <p>前端处理，秒级响应</p>
                                            </div>
                                        </div>
                                        <ul class="mode-features">
                                            <li>即时处理</li>
                                            <li>无需服务器</li>
                                            <li>浏览器本地分词</li>
                                            <li class="mode-limit">推荐 &lt; 1,000 条消息</li>
                                        </ul>
                                    </div>
                                </label>

                                <label class="mode-option">
                                    <input type="radio" name="processingMode" value="precise">
                                    <div class="mode-card">
                                        <div class="mode-card-header">
                                            <div class="mode-icon">
                                                <i class="ri-precision-line"></i>
                                            </div>
                                            <div class="mode-title">
                                                <h3>精确模式</h3>
                                                <p>后端处理，精确分析</p>
                                            </div>
                                        </div>
                                        <ul class="mode-features">
                                            <li>jieba 精确分词</li>
                                            <li>改进的情感分析</li>
                                            <li>TF-IDF 关键词提取</li>
                                            <li class="mode-limit">适合大数据集</li>
                                        </ul>
                                        <div class="mode-badge" id="edgeFunctionStatus" style="display: none;">
                                            <i class="ri-cloud-line"></i>
                                            可用
                                        </div>
                                    </div>
                                </label>
                            </div>
                            <div class="mode-hint" id="modeHint">
                                <i class="ri-information-line"></i>
                                <span>快速模式使用浏览器内置分词，精确模式需要配置边缘函数</span>
                            </div>
                        </div>

                        <!-- 进度条 -->
                        <div class="progress-container" id="import-progress" style="display: none;">
                            <div class="progress-bar-bg">
                                <div id="progress-bar-fill" class="progress-bar-fill" style="width: 0%;"></div>
                            </div>
                            <div id="progress-text" class="progress-text">准备导入...</div>
                        </div>

                        <div class="form-actions">
                            <button class="btn btn-primary" id="import-btn" onclick="startImport()">
                                <i class="ri-upload-line"></i>
                                开始导入
                            </button>
                            <button class="btn btn-secondary" onclick="resetImportForm()">
                                <i class="ri-refresh-line"></i>
                                重置
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 数据集列表 -->
            <section class="datasets-section">
                <div class="section-header">
                    <h2><i class="ri-folder-line"></i> 我的数据集</h2>
                    <span class="dataset-count" id="dataset-count">0 个数据集</span>
                </div>

                <div id="dataset-list" class="dataset-list">
                    <!-- 数据集卡片将动态生成 -->
                </div>
            </section>

            <!-- 黑名单设置 -->
            <section class="settings-section">
                <div class="section-header">
                    <h2><i class="ri-shield-keyhole-line"></i> 黑名单设置</h2>
                    <label class="toggle-switch">
                        <input type="checkbox" id="blacklist-toggle" checked onchange="toggleBlacklist()">
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div class="settings-content" id="blacklist-settings">
                    <div class="setting-item">
                        <div class="setting-info">
                            <h3><i class="ri-bracket-line"></i> 中括号标记过滤</h3>
                            <p>自动过滤用中括号 [ ] 括起来的内容。在聊天记录中用中括号标记不希望显示的关键词。</p>
                            <div class="setting-example">
                                <strong>示例：</strong>
                                <code>今天讨论了[广告]相关的内容，很棒！</code>
                                <span class="example-arrow">→</span>
                                <code>今天讨论了相关的内容，很棒！</code>
                            </div>
                        </div>
                    </div>

                    <div class="setting-item">
                        <div class="setting-info">
                            <h3><i class="ri-filter-line"></i> 过滤策略</h3>
                            <p>选择包含标记内容的处理方式：</p>
                        </div>
                        <div class="setting-control">
                            <select id="blacklist-strategy" class="form-select" onchange="updateBlacklistStrategy()">
                                <option value="filter_only" selected>仅过滤关键词（推荐）</option>
                                <option value="skip">跳过整条消息</option>
                                <option value="mark">标记但保留消息</option>
                            </select>
                        </div>
                    </div>

                    <div class="setting-status" id="blacklist-status">
                        <i class="ri-checkbox-circle-line" style="color: #10b981;"></i>
                        <span>黑名单过滤已启用</span>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Toast 提示 -->
    <div class="toast-container" id="toast-container">
        <div class="toast toast-success" id="toast-success">
            <i class="ri-checkbox-circle-line"></i>
            <span></span>
        </div>
        <div class="toast toast-error" id="toast-error">
            <i class="ri-error-warning-line"></i>
            <span></span>
        </div>
        <div class="toast toast-warning" id="toast-warning">
            <i class="ri-alert-line"></i>
            <span></span>
        </div>
        <div class="toast toast-info" id="toast-info">
            <i class="ri-information-line"></i>
            <span></span>
        </div>
    </div>

    <!-- 加载脚本 -->
    <script src="js/config.js"></script>
    <script src="js/logger.js"></script>
    <script src="js/error-handler.js"></script>
    <script src="js/data-manager.js"></script>
    <script src="js/data-share.js"></script>
    <script src="js/data-import.js"></script>
    <script src="js/processors/text-processor.js"></script>
    <script src="js/edge-function-config.js"></script>
    <script src="js/data-manager-ui.js?v=1.1.0-session-storage"></script>

    <!-- 分享功能 UI 组件 -->
    <script src="js/ui/share-modal.js"></script>
    <script src="js/ui/import-share-modal.js"></script>

    <!-- 边缘函数配置UI逻辑 -->
    <script>
        // 检查边缘函数是否可用
        document.addEventListener('DOMContentLoaded', () => {
            if (window.EdgeFunctionConfig && window.EdgeFunctionConfig.isAvailable('processChat')) {
                // 显示"可用"徽章
                const badge = document.getElementById('edgeFunctionStatus');
                if (badge) {
                    badge.style.display = 'block';
                    badge.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
                }

                // 更新提示信息
                const hint = document.getElementById('modeHint');
                if (hint) {
                    hint.innerHTML = '<i class="ri-checkbox-circle-line"></i><span>边缘函数已配置，可以使用精确模式</span>';
                    hint.style.color = '#10b981';
                }

                console.log('[OK] Edge Function is available');
            } else {
                console.warn('[WARN] Edge Function not configured');

                // 添加配置按钮
                const hint = document.getElementById('modeHint');
                if (hint) {
                    hint.innerHTML = `
                        <i class="ri-alert-line"></i>
                        <span>边缘函数未配置，将使用快速模式</span>
                        <button onclick="configureEdgeFunction()" style="margin-left: 8px; padding: 4px 12px; font-size: 12px; background: var(--accent-color, #667eea); color: white; border: none; border-radius: 4px; cursor: pointer;">
                            配置
                        </button>
                    `;
                }
            }

            // 监听模式切换
            const modeInputs = document.querySelectorAll('input[name="processingMode"]');
            modeInputs.forEach(input => {
                input.addEventListener('change', (e) => {
                    if (e.target.value === 'precise' && !window.EdgeFunctionConfig.isAvailable('processChat')) {
                        // 如果选择精确模式但边缘函数未配置，给出提示
                        if (confirm('精确模式需要配置边缘函数。\n\n是否立即配置？')) {
                            configureEdgeFunction();
                        } else {
                            // 切换回快速模式
                            document.querySelector('input[name="processingMode"][value="fast"]').checked = true;
                        }
                    }
                });
            });
        });

        // 配置边缘函数
        function configureEdgeFunction() {
            const url = prompt('请输入边缘函数 URL：\n\n(例如: https://your-function-url)', window.EdgeFunctionConfig?.getUrl('processChat') || '');

            if (url && url.trim()) {
                window.EdgeFunctionConfig.setUrl('processChat', url.trim());
                alert('[OK] 边缘函数URL已保存！\n\n正在测试连接...');

                // 测试连接
                window.EdgeFunctionConfig.testConnection('processChat').then(result => {
                    if (result.success) {
                        alert('[OK] 边缘函数连接成功！\n\n现在可以使用精确模式了。');
                        // 刷新页面以更新UI
                        location.reload();
                    } else {
                        alert('[ERROR] 边缘函数连接失败：\n' + result.error + '\n\n请检查URL是否正确。');
                    }
                });
            }
        }

        // 在控制台提供便捷的配置方法
        window.configureEdgeFunction = configureEdgeFunction;

        // 打开导入分享模态框
        function openImportShare() {
            document.dispatchEvent(new CustomEvent('importShare'));
        }
        window.openImportShare = openImportShare;

        // 打开分享模态框
        function openShareModal(datasetId) {
            document.dispatchEvent(new CustomEvent('shareDataset', {
                detail: { datasetId }
            }));
        }
        window.openShareModal = openShareModal;
    </script>

    <!-- 分享和导入分享模态框组件 -->
    <share-modal></share-modal>
    <import-share-modal></import-share-modal>

</body>
</html>
