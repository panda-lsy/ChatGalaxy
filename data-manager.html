<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f1419">
    <!-- ğŸ”§ æ·»åŠ  favicon -->
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <title>æ•°æ®ç®¡ç†å™¨ - ChatGalaxy</title>
    <link href="js/lib/remixicon/remixicon.css" rel="stylesheet">
    <link rel="stylesheet" href="css/data-manager.css">
    <link rel="stylesheet" href="css/processing-mode-selector.css">
    <link rel="stylesheet" href="css/share-modal.css">

    <!-- ğŸ†• ä¸»é¢˜ç³»ç»Ÿ CSS -->
    <link rel="stylesheet" href="css/theme/base.css">
    <link rel="stylesheet" href="css/theme/schemes.css">
    <link rel="stylesheet" href="css/theme/transparency.css">
</head>
<body>
    <!-- èƒŒæ™¯è£…é¥° - ä¸ä¸»é¡µé¢ä¸€è‡´ -->
    <div class="bg-decoration">
        <div class="bg-circle circle-1"></div>
        <div class="bg-circle circle-2"></div>
        <div class="bg-circle circle-3"></div>
    </div>

    <!-- ä¸»å®¹å™¨ -->
    <div class="manager-container">
        <!-- å¤´éƒ¨ -->
        <header class="manager-header">
            <div class="header-content">
                <div class="header-left">
                    <button class="back-btn" onclick="window.location.href='index.html'" title="è¿”å›æ˜Ÿç³»">
                        <i class="ri-arrow-go-back-line"></i>
                    </button>
                    <div class="header-title">
                        <h1><i class="ri-database-2-line"></i> æ•°æ®ç®¡ç†å™¨</h1>
                        <p>ç®¡ç†æ‚¨çš„èŠå¤©æ•°æ®é›†</p>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="action-btn secondary" onclick="createNewDataset()">
                        <i class="ri-add-circle-line"></i>
                        <span>åˆ›å»ºç©ºæ•°æ®é›†</span>
                    </button>
                    <button class="action-btn secondary" onclick="openImportShare()">
                        <i class="ri-download-cloud-line"></i>
                        <span>å¯¼å…¥åˆ†äº«</span>
                    </button>
                    <button class="action-btn secondary" onclick="loadDemoDataset()">
                        <i class="ri-magic-line"></i>
                        <span>æ¼”ç¤ºæ•°æ®</span>
                    </button>
                    <button class="action-btn secondary" onclick="refreshDatasetList()">
                        <i class="ri-refresh-line"></i>
                        <span>åˆ·æ–°</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- ä¸»å†…å®¹åŒº -->
        <main class="manager-main">
            <!-- å¯¼å…¥é¢æ¿ -->
            <section class="import-section">
                <div class="section-header" onclick="toggleImportPanel()">
                    <h2><i class="ri-upload-cloud-line"></i> å¯¼å…¥æ•°æ®é›†</h2>
                    <button class="collapse-btn">
                        <i class="ri-arrow-down-s-line" id="import-panel-icon"></i>
                    </button>
                </div>

                <div class="import-content" id="import-panel-content">
                    <!-- ä¸Šä¼ åŒºåŸŸ -->
                    <div class="upload-zone" id="upload-zone">
                        <div class="upload-icon">
                            <i class="ri-cloud-upload-line"></i>
                        </div>
                        <div class="upload-text">æ‹–æ‹½JSONæ–‡ä»¶åˆ°æ­¤å¤„ï¼Œæˆ–ç‚¹å‡»é€‰æ‹©</div>
                        <div class="upload-hint">æ”¯æŒæœ€å¤§10MBçš„JSONæ–‡ä»¶</div>
                        <input type="file" id="file-input" accept=".json" style="display: none;">
                    </div>

                    <!-- æ–‡ä»¶ä¿¡æ¯ -->
                    <div class="file-info" id="file-info" style="display: none;">
                        <i class="ri-file-text-line"></i>
                        <span id="file-name"></span>
                    </div>

                    <!-- éªŒè¯è­¦å‘Š -->
                    <div class="validation-warnings" id="validation-warnings" style="display: none;">
                        <h4><i class="ri-alert-line"></i> å¯¼å…¥è­¦å‘Š</h4>
                        <ul id="validation-warning-list"></ul>
                    </div>

                    <!-- æ•°æ®é›†è¡¨å• -->
                    <div class="dataset-form" id="dataset-form" style="display: none;">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">æ•°æ®é›†åç§° <span class="required">*</span></label>
                                <input type="text" id="dataset-name" class="form-input" placeholder="ä¾‹å¦‚ï¼šæˆ‘çš„èŠå¤©è®°å½•">
                            </div>

                            <div class="form-group">
                                <label class="form-label">ä¸»é¢˜é¢œè‰²</label>
                                <div class="color-selector" id="color-selector">
                                    <div class="color-option selected" style="background: #3498db;" data-color="#3498db" onclick="selectColor(this)"></div>
                                    <div class="color-option" style="background: #10b981;" data-color="#10b981" onclick="selectColor(this)"></div>
                                    <div class="color-option" style="background: #f59e0b;" data-color="#f59e0b" onclick="selectColor(this)"></div>
                                    <div class="color-option" style="background: #ef4444;" data-color="#ef4444" onclick="selectColor(this)"></div>
                                    <div class="color-option" style="background: #8b5cf6;" data-color="#8b5cf6" onclick="selectColor(this)"></div>
                                    <div class="color-option" style="background: #ec4899;" data-color="#ec4899" onclick="selectColor(this)"></div>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">æè¿°ï¼ˆå¯é€‰ï¼‰</label>
                            <textarea id="dataset-description" class="form-textarea" placeholder="ç®€å•æè¿°è¿™ä¸ªæ•°æ®é›†..." rows="3"></textarea>
                        </div>

                        <div class="form-group">
                            <label class="form-label">æ ‡ç­¾</label>
                            <div class="tag-selector" id="tag-selector">
                                <div class="tag-option" onclick="toggleTag(this)">æ¸¸æˆ</div>
                                <div class="tag-option" onclick="toggleTag(this)">å·¥ä½œ</div>
                                <div class="tag-option" onclick="toggleTag(this)">å­¦ä¹ </div>
                                <div class="tag-option" onclick="toggleTag(this)">ç”Ÿæ´»</div>
                                <div class="tag-option" onclick="toggleTag(this)">ç¤¾äº¤</div>
                                <div class="tag-option" onclick="toggleTag(this)">å…¶ä»–</div>
                            </div>
                        </div>

                        <!-- å¤„ç†æ¨¡å¼é€‰æ‹© -->
                        <div class="form-group">
                            <label class="form-label">
                                å¤„ç†æ¨¡å¼
                                <span class="label-hint" title="é€‰æ‹©æ•°æ®å¤„ç†æ–¹å¼">â“˜</span>
                            </label>
                            <div class="processing-mode-selector">
                                <label class="mode-option">
                                    <input type="radio" name="processingMode" value="fast" checked>
                                    <div class="mode-card">
                                        <div class="mode-card-header">
                                            <div class="mode-icon">
                                                <i class="ri-flash-line"></i>
                                            </div>
                                            <div class="mode-title">
                                                <h3>å¿«é€Ÿæ¨¡å¼</h3>
                                                <p>å‰ç«¯å¤„ç†ï¼Œç§’çº§å“åº”</p>
                                            </div>
                                        </div>
                                        <ul class="mode-features">
                                            <li>å³æ—¶å¤„ç†</li>
                                            <li>æ— éœ€æœåŠ¡å™¨</li>
                                            <li>æµè§ˆå™¨æœ¬åœ°åˆ†è¯</li>
                                            <li class="mode-limit">æ¨è &lt; 1,000 æ¡æ¶ˆæ¯</li>
                                        </ul>
                                    </div>
                                </label>

                                <label class="mode-option">
                                    <input type="radio" name="processingMode" value="precise">
                                    <div class="mode-card">
                                        <div class="mode-card-header">
                                            <div class="mode-icon">
                                                <i class="ri-precision-line"></i>
                                            </div>
                                            <div class="mode-title">
                                                <h3>ç²¾ç¡®æ¨¡å¼</h3>
                                                <p>åç«¯å¤„ç†ï¼Œç²¾ç¡®åˆ†æ</p>
                                            </div>
                                        </div>
                                        <ul class="mode-features">
                                            <li>jieba ç²¾ç¡®åˆ†è¯</li>
                                            <li>æ”¹è¿›çš„æƒ…æ„Ÿåˆ†æ</li>
                                            <li>TF-IDF å…³é”®è¯æå–</li>
                                            <li class="mode-limit">é€‚åˆå¤§æ•°æ®é›†</li>
                                        </ul>
                                        <div class="mode-badge" id="edgeFunctionStatus" style="display: none;">
                                            <i class="ri-cloud-line"></i>
                                            å¯ç”¨
                                        </div>
                                    </div>
                                </label>
                            </div>
                            <div class="mode-hint" id="modeHint">
                                <i class="ri-information-line"></i>
                                <span>å¿«é€Ÿæ¨¡å¼ä½¿ç”¨æµè§ˆå™¨å†…ç½®åˆ†è¯ï¼Œç²¾ç¡®æ¨¡å¼éœ€è¦é…ç½®è¾¹ç¼˜å‡½æ•°</span>
                            </div>
                        </div>

                        <!-- è¿›åº¦æ¡ -->
                        <div class="progress-container" id="import-progress" style="display: none;">
                            <div class="progress-bar-bg">
                                <div id="progress-bar-fill" class="progress-bar-fill" style="width: 0%;"></div>
                            </div>
                            <div id="progress-text" class="progress-text">å‡†å¤‡å¯¼å…¥...</div>
                        </div>

                        <div class="form-actions">
                            <button class="btn btn-primary" id="import-btn" onclick="startImport()">
                                <i class="ri-upload-line"></i>
                                å¼€å§‹å¯¼å…¥
                            </button>
                            <button class="btn btn-secondary" onclick="resetImportForm()">
                                <i class="ri-refresh-line"></i>
                                é‡ç½®
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- æ•°æ®é›†åˆ—è¡¨ -->
            <section class="datasets-section">
                <div class="section-header">
                    <h2><i class="ri-folder-line"></i> æˆ‘çš„æ•°æ®é›†</h2>
                    <span class="dataset-count" id="dataset-count">0 ä¸ªæ•°æ®é›†</span>
                </div>

                <div id="dataset-list" class="dataset-list">
                    <!-- æ•°æ®é›†å¡ç‰‡å°†åŠ¨æ€ç”Ÿæˆ -->
                </div>
            </section>

            <!-- é»‘åå•è®¾ç½® -->
            <section class="settings-section">
                <div class="section-header">
                    <h2><i class="ri-shield-keyhole-line"></i> é»‘åå•è®¾ç½®</h2>
                    <label class="toggle-switch">
                        <input type="checkbox" id="blacklist-toggle" checked onchange="toggleBlacklist()">
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div class="settings-content" id="blacklist-settings">
                    <div class="setting-item">
                        <div class="setting-info">
                            <h3><i class="ri-bracket-line"></i> ä¸­æ‹¬å·æ ‡è®°è¿‡æ»¤</h3>
                            <p>è‡ªåŠ¨è¿‡æ»¤ç”¨ä¸­æ‹¬å· [ ] æ‹¬èµ·æ¥çš„å†…å®¹ã€‚åœ¨èŠå¤©è®°å½•ä¸­ç”¨ä¸­æ‹¬å·æ ‡è®°ä¸å¸Œæœ›æ˜¾ç¤ºçš„å…³é”®è¯ã€‚</p>
                            <div class="setting-example">
                                <strong>ç¤ºä¾‹ï¼š</strong>
                                <code>ä»Šå¤©è®¨è®ºäº†[å¹¿å‘Š]ç›¸å…³çš„å†…å®¹ï¼Œå¾ˆæ£’ï¼</code>
                                <span class="example-arrow">â†’</span>
                                <code>ä»Šå¤©è®¨è®ºäº†ç›¸å…³çš„å†…å®¹ï¼Œå¾ˆæ£’ï¼</code>
                            </div>
                        </div>
                    </div>

                    <div class="setting-item">
                        <div class="setting-info">
                            <h3><i class="ri-filter-line"></i> è¿‡æ»¤ç­–ç•¥</h3>
                            <p>é€‰æ‹©åŒ…å«æ ‡è®°å†…å®¹çš„å¤„ç†æ–¹å¼ï¼š</p>
                        </div>
                        <div class="setting-control">
                            <select id="blacklist-strategy" class="form-select" onchange="updateBlacklistStrategy()">
                                <option value="filter_only" selected>ä»…è¿‡æ»¤å…³é”®è¯ï¼ˆæ¨èï¼‰</option>
                                <option value="skip">è·³è¿‡æ•´æ¡æ¶ˆæ¯</option>
                                <option value="mark">æ ‡è®°ä½†ä¿ç•™æ¶ˆæ¯</option>
                            </select>
                        </div>
                    </div>

                    <div class="setting-status" id="blacklist-status">
                        <i class="ri-checkbox-circle-line" style="color: var(--success-color);"></i>
                        <span>é»‘åå•è¿‡æ»¤å·²å¯ç”¨</span>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Toast æç¤º -->
    <div class="toast-container" id="toast-container">
        <div class="toast toast-success" id="toast-success">
            <i class="ri-checkbox-circle-line"></i>
            <span></span>
        </div>
        <div class="toast toast-error" id="toast-error">
            <i class="ri-error-warning-line"></i>
            <span></span>
        </div>
        <div class="toast toast-warning" id="toast-warning">
            <i class="ri-alert-line"></i>
            <span></span>
        </div>
        <div class="toast toast-info" id="toast-info">
            <i class="ri-information-line"></i>
            <span></span>
        </div>
    </div>

    <!-- åŠ è½½è„šæœ¬ -->
    <script src="js/config.js"></script>
    <script src="js/logger.js"></script>
    <script src="js/error-handler.js"></script>
    <script src="js/data-manager.js"></script>
    <script src="js/data-share.js"></script>
    <script src="js/data-import.js"></script>
    <script src="js/processors/text-processor.js"></script>
    <script src="js/edge-function-config.js"></script>
    <script src="js/data-manager-ui.js?v=1.1.0-session-storage"></script>

    <!-- åˆ†äº«åŠŸèƒ½ UI ç»„ä»¶ -->
    <script src="js/ui/share-modal.js"></script>
    <script src="js/ui/import-share-modal.js"></script>

    <!-- è¾¹ç¼˜å‡½æ•°é…ç½®UIé€»è¾‘ -->
    <script>
        // æ£€æŸ¥è¾¹ç¼˜å‡½æ•°æ˜¯å¦å¯ç”¨
        document.addEventListener('DOMContentLoaded', () => {
            if (window.EdgeFunctionConfig && window.EdgeFunctionConfig.isAvailable('processChat')) {
                // æ˜¾ç¤º"å¯ç”¨"å¾½ç« 
                const badge = document.getElementById('edgeFunctionStatus');
                if (badge) {
                    badge.style.display = 'block';
                    badge.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
                }

                // æ›´æ–°æç¤ºä¿¡æ¯
                const hint = document.getElementById('modeHint');
                if (hint) {
                    hint.innerHTML = '<i class="ri-checkbox-circle-line"></i><span>è¾¹ç¼˜å‡½æ•°å·²é…ç½®ï¼Œå¯ä»¥ä½¿ç”¨ç²¾ç¡®æ¨¡å¼</span>';
                    hint.style.color = '#10b981';
                }

                console.log('[OK] Edge Function is available');
            } else {
                console.warn('[WARN] Edge Function not configured');

                // æ·»åŠ é…ç½®æŒ‰é’®
                const hint = document.getElementById('modeHint');
                if (hint) {
                    hint.innerHTML = `
                        <i class="ri-alert-line"></i>
                        <span>è¾¹ç¼˜å‡½æ•°æœªé…ç½®ï¼Œå°†ä½¿ç”¨å¿«é€Ÿæ¨¡å¼</span>
                        <button onclick="configureEdgeFunction()" style="margin-left: 8px; padding: 4px 12px; font-size: 12px; background: var(--accent-color, #667eea); color: white; border: none; border-radius: 4px; cursor: pointer;">
                            é…ç½®
                        </button>
                    `;
                }
            }

            // ç›‘å¬æ¨¡å¼åˆ‡æ¢
            const modeInputs = document.querySelectorAll('input[name="processingMode"]');
            modeInputs.forEach(input => {
                input.addEventListener('change', (e) => {
                    if (e.target.value === 'precise' && !window.EdgeFunctionConfig.isAvailable('processChat')) {
                        // å¦‚æœé€‰æ‹©ç²¾ç¡®æ¨¡å¼ä½†è¾¹ç¼˜å‡½æ•°æœªé…ç½®ï¼Œç»™å‡ºæç¤º
                        if (confirm('ç²¾ç¡®æ¨¡å¼éœ€è¦é…ç½®è¾¹ç¼˜å‡½æ•°ã€‚\n\næ˜¯å¦ç«‹å³é…ç½®ï¼Ÿ')) {
                            configureEdgeFunction();
                        } else {
                            // åˆ‡æ¢å›å¿«é€Ÿæ¨¡å¼
                            document.querySelector('input[name="processingMode"][value="fast"]').checked = true;
                        }
                    }
                });
            });
        });

        // é…ç½®è¾¹ç¼˜å‡½æ•°
        function configureEdgeFunction() {
            const url = prompt('è¯·è¾“å…¥è¾¹ç¼˜å‡½æ•° URLï¼š\n\n(ä¾‹å¦‚: https://your-function-url)', window.EdgeFunctionConfig?.getUrl('processChat') || '');

            if (url && url.trim()) {
                window.EdgeFunctionConfig.setUrl('processChat', url.trim());
                alert('[OK] è¾¹ç¼˜å‡½æ•°URLå·²ä¿å­˜ï¼\n\næ­£åœ¨æµ‹è¯•è¿æ¥...');

                // æµ‹è¯•è¿æ¥
                window.EdgeFunctionConfig.testConnection('processChat').then(result => {
                    if (result.success) {
                        alert('[OK] è¾¹ç¼˜å‡½æ•°è¿æ¥æˆåŠŸï¼\n\nç°åœ¨å¯ä»¥ä½¿ç”¨ç²¾ç¡®æ¨¡å¼äº†ã€‚');
                        // åˆ·æ–°é¡µé¢ä»¥æ›´æ–°UI
                        location.reload();
                    } else {
                        alert('[ERROR] è¾¹ç¼˜å‡½æ•°è¿æ¥å¤±è´¥ï¼š\n' + result.error + '\n\nè¯·æ£€æŸ¥URLæ˜¯å¦æ­£ç¡®ã€‚');
                    }
                });
            }
        }

        // åœ¨æ§åˆ¶å°æä¾›ä¾¿æ·çš„é…ç½®æ–¹æ³•
        window.configureEdgeFunction = configureEdgeFunction;

        // æ‰“å¼€å¯¼å…¥åˆ†äº«æ¨¡æ€æ¡†
        function openImportShare() {
            document.dispatchEvent(new CustomEvent('importShare'));
        }
        window.openImportShare = openImportShare;

        // æ‰“å¼€åˆ†äº«æ¨¡æ€æ¡†
        function openShareModal(datasetId) {
            document.dispatchEvent(new CustomEvent('shareDataset', {
                detail: { datasetId }
            }));
        }
        window.openShareModal = openShareModal;
    </script>

    <!-- åˆ†äº«å’Œå¯¼å…¥åˆ†äº«æ¨¡æ€æ¡†ç»„ä»¶ -->
    <share-modal></share-modal>
    <import-share-modal></import-share-modal>

    <!-- ğŸ†• ä¸»é¢˜ç³»ç»Ÿ JavaScript -->
    <script type="module">
        import { autoMigrateAndApply } from './js/theme/migration.js';
        import { ThemeManager } from './js/theme/theme-manager.js';

        // è‡ªåŠ¨è¿ç§»å¹¶åˆå§‹åŒ–ä¸»é¢˜
        autoMigrateAndApply();

        // ç›‘å¬ä¸»é¢˜å˜æ›´
        if (window.ThemeManager) {
            window.ThemeManager.on('themeChange', (data) => {
                console.log(`ğŸ¨ [data-manager.html] Theme changed: ${data.oldTheme} â†’ ${data.newTheme}`);
                // ä¸»é¢˜å˜æ›´åï¼ŒCSSå˜é‡ä¼šè‡ªåŠ¨æ›´æ–°ï¼Œè¡¨æ ¼æ ·å¼ä¼šéšä¹‹å˜åŒ–
            });
        }
    </script>

</body>
</html>
