<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#2b1055">
    <!-- ğŸ”§ æ·»åŠ  favicon -->
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <title>ChatGalaxy - èŠå¤©æ˜Ÿç³»å¯è§†åŒ–</title>
    <script>
        // åªåœ¨é¦–æ¬¡è®¿é—®æ—¶è·³è½¬åˆ°introé¡µé¢ï¼ˆé™¤éURLå‚æ•°å¼ºåˆ¶è·³è¿‡ï¼‰
        (function() {
            const urlParams = new URLSearchParams(window.location.search);
            const forceSkip = urlParams.has('skip') || urlParams.has('nointro');

            // æ£€æŸ¥ sessionStorage æ˜¯å¦å·²ç»çœ‹è¿‡ intro
            const hasSeenIntro = sessionStorage.getItem('chatgalaxy_intro_seen');

            console.log('ğŸ” æ£€æŸ¥è·³è½¬é€»è¾‘:', {
                forceSkip,
                hasSeenIntro,
                referrer: document.referrer,
                pathname: window.location.pathname
            });

            // åªæœ‰é¦–æ¬¡è®¿é—®æ‰è·³è½¬ï¼ˆURLå‚æ•°å¼ºåˆ¶è·³è¿‡æˆ–å·²çœ‹è¿‡introåˆ™ä¸è·³è½¬ï¼‰
            if (!forceSkip && !hasSeenIntro) {
                console.log('âœ… é¦–æ¬¡è®¿é—®ï¼Œè·³è½¬åˆ° intro.html');
                window.location.href = 'intro.html';
            } else {
                console.log('â­ï¸ è·³è¿‡ intro é¡µé¢ï¼ˆURLå‚æ•°å¼ºåˆ¶æˆ–å·²çœ‹è¿‡ï¼‰');
                // æ ‡è®°å·²ç»çœ‹è¿‡ introï¼ˆä¸‹æ¬¡è®¿é—®ä¸å†æ˜¾ç¤ºï¼‰
                sessionStorage.setItem('chatgalaxy_intro_seen', 'true');
            }
        })();
    </script>
    <!-- Load Three.js (r149 - Stable for 3d-force-graph) -->
    <script src="js/lib/three.min.js" defer></script>
    <!-- Load D3.js -->
    <script src="js/lib/d3.min.js" defer></script>
    <!-- Load 3D Force Graph -->
    <script src="js/lib/3d-force-graph.min.js" defer></script>
    <link href="js/lib/remixicon/remixicon.css" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/roam.css">
    <link rel="stylesheet" href="css/settings.css">
    <link rel="stylesheet" href="css/emoji.css">
    <link rel="stylesheet" href="css/sidebar.css">
    <link rel="stylesheet" href="css/data-manager.css">

    <!-- ğŸ†• ä¸»é¢˜ç³»ç»Ÿ CSS -->
    <link rel="stylesheet" href="css/theme/base.css">
    <link rel="stylesheet" href="css/theme/schemes.css">
    <link rel="stylesheet" href="css/theme/transparency.css">
    <link rel="stylesheet" href="css/components/sidebar.css">
    <link rel="stylesheet" href="css/components/theme-controls.css">
</head>
<body data-theme="light">

<div id="intro-overlay" class="experience-overlay hidden">
    <div class="overlay-inner">
        <div class="eyebrow">åºå¹•</div>
        <h1>æŠŠç¢ç‰‡ç‚¹æˆæ˜Ÿæµ·</h1>
        <p class="subtext">æ¯ä¸€æ¡æ¶ˆæ¯éƒ½æ˜¯ä¸€ç²’æ˜Ÿæ²™ã€‚è®©æˆ‘ä»¬ä¸€èµ·æŠŠå®ƒä»¬æ’’å‘å¤œç©ºï¼Œæ‹¼æˆåªå±äºä½ ä»¬çš„é“¶æ²³ã€‚</p>
        <div class="overlay-actions">
            <button id="start-experience-btn" class="primary">å¼€å¯å›å¿†</button>
        </div>
    </div>
    <div class="overlay-glow"></div>
</div>

<div id="outro-overlay" class="experience-overlay hidden">
    <div class="overlay-inner">
        <div class="eyebrow">æ”¶æŸ</div>
        <h1>é“¶æ²³ä»åœ¨å‘å…‰</h1>
        <p class="subtext">æ—…ç¨‹ä¸ä¼šç»“æŸï¼Œå…‰ç‚¹ä¼šä¸€ç›´å®ˆåœ¨è¿™é‡Œã€‚å›æ¥çš„æ—¶å€™ï¼Œå®ƒä»¬ä»ä¼šä¸ºä½ ç‚¹äº®ã€‚</p>
        <div class="overlay-actions">
            <button id="stay-btn">å†åœç•™ä¸€ä¼š</button>
            <button id="return-btn" class="primary">è¿”å›æ˜Ÿæµ·</button>
        </div>
    </div>
    <div class="overlay-glow"></div>
</div>

<div id="loading">
    <div class="spinner"></div>
    <p>æ­£åœ¨åŠ è½½æ•°æ®...</p>
</div>

<!-- ğŸ”§ Demo è¿è¡ŒæŒ‡ç¤ºå™¨ -->
<div id="demo-indicator" class="demo-indicator hidden">
    <div class="demo-indicator-content">
        <i class="ri-play-circle-line demo-icon"></i>
        <span class="demo-text">æ­£åœ¨è¿è¡Œ Demo æ•°æ®</span>
        <div class="demo-pulse"></div>
    </div>
</div>

<!-- å·¦ä¾§ä¾§è¾¹æ å±•å¼€æŒ‰é’®ï¼ˆæŠ˜å æ—¶æ˜¾ç¤ºï¼‰ -->
<button id="message-sidebar-toggle-fixed" title="å±•å¼€ä¾§è¾¹æ ">
    <i class="ri-menu-unfold-line"></i>
</button>

<div id="message-sidebar">
    <div id="sidebar-header">
        <button id="message-sidebar-toggle" class="sidebar-collapse-btn" title="æŠ˜å /å±•å¼€">
            <i class="ri-menu-fold-line"></i>
        </button>
        <div class="app-title"><i class="ri-space-line"></i> ChatGalaxy</div>
        <div id="stats-bar">
            <div class="stat-item">
                <span class="stat-val" id="stat-total">0</span>
                <span class="stat-label">æ¶ˆæ¯</span>
            </div>
            <div class="stat-item">
                <span class="stat-val" id="stat-users">0</span>
                <span class="stat-label">ç”¨æˆ·</span>
            </div>
            <div class="stat-item">
                <span class="stat-val" id="stat-days">0</span>
                <span class="stat-label">å¤©æ•°</span>
            </div>
        </div>
    </div>
    <div id="controls">
        <div class="control-group">
            <div class="search-box">
                <i class="ri-search-line"></i>
                <input type="text" id="search-input" placeholder="æœç´¢èŠå¤©å†…å®¹..." oninput="handleSearch(this.value)">
            </div>
        </div>
        <div class="control-group">
            <div id="sidebar-tabs">
                <button class="tab-btn active" onclick="switchTab('messages')">æ¶ˆæ¯åˆ—è¡¨</button>
                <button class="tab-btn" onclick="switchTab('keywords')">å…³é”®è¯æ¦œ</button>
            </div>
            <div id="sentiment-filters" class="filter-group">
                <button class="filter-btn active" onclick="filterSentiment('all')" title="å…¨éƒ¨"><i class="ri-apps-line"></i></button>
                <button class="filter-btn happy" onclick="filterSentiment('happy')" title="å¼€å¿ƒ"><i class="ri-emotion-happy-line"></i></button>
                <button class="filter-btn sad" onclick="filterSentiment('sad')" title="éš¾è¿‡"><i class="ri-emotion-sad-line"></i></button>
                <button class="filter-btn question" onclick="filterSentiment('question')" title="ç–‘é—®"><i class="ri-question-mark"></i></button>
            </div>
        </div>
    </div>
    
    <div id="tab-content-messages" class="tab-content active">
        <div id="chat-list-container">
            <div id="chat-list-content">
                <!-- Messages will be injected here -->
            </div>
        </div>
    </div>
    
    <div id="tab-content-keywords" class="tab-content" style="display:none; flex: 1; overflow-y: auto;">
        <div id="keyword-ranking-list">
            <!-- Keywords will be injected here -->
        </div>
    </div>
</div>

<div id="main-view">
    <div id="graph-container"></div>
    
    <div id="info-overlay">
        <h3></h3>
        <p></p>
    </div>
    <div id="subtitle-overlay"></div>
    <div id="toast-container"></div>
</div>

<!-- Time Travel Slider -->
<div id="time-travel-container">
    <div class="time-label">
        <i class="ri-time-line"></i>
        <span id="current-date">2024-01-01</span>
    </div>
    <input type="range" id="time-slider" min="0" max="100" value="100" step="0.1">
    <div class="time-controls">
        <button id="play-btn" title="æ’­æ”¾å›å¿†"><i class="ri-play-fill"></i></button>
    </div>
</div>

<!-- Settings Modal -->
<div id="settings-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2>è®¾ç½®</h2>
            <button id="close-settings" class="icon-btn"><i class="ri-close-line"></i></button>
        </div>
        <div class="modal-body">
            <!-- Audio -->
            <div class="setting-group">
                <h3>éŸ³é¢‘è®¾ç½®</h3>
                <div class="setting-item checkbox-row">
                    <input type="checkbox" id="sfx-enabled" checked>
                    <label for="sfx-enabled">å¼€å¯äº¤äº’éŸ³æ•ˆ</label>
                </div>
                <div class="setting-item">
                    <label>èƒŒæ™¯éŸ³ä¹éŸ³é‡ <span id="bgm-vol-val">50%</span></label>
                    <input type="range" id="bgm-vol" min="0" max="100" value="50">
                </div>
                <div class="setting-item">
                    <label>éŸ³æ•ˆéŸ³é‡ <span id="sfx-vol-val">50%</span></label>
                    <input type="range" id="sfx-vol" min="0" max="100" value="50">
                </div>
            </div>
            <!-- Appearance -->
            <div class="setting-group">
                <h3>ç•Œé¢ä¸ªæ€§åŒ–</h3>
                <div class="setting-item">
                    <label>ç½‘é¡µæ ‡é¢˜</label>
                    <input type="text" id="page-title-input" value="ChatGalaxy">
                </div>
                <div class="setting-item">
                    <label>ç½‘é¡µå›¾æ ‡ (Emoji)</label>
                    <div class="input-with-btn">
                        <input type="text" id="page-icon-input" value="ğŸŒŒ" maxlength="2" placeholder="è¾“å…¥ emoji">
                    </div>
                </div>
                <div class="setting-item">
                    <label>ä¾§è¾¹æ æ ‡é¢˜</label>
                    <input type="text" id="sidebar-title-input" value="ChatGalaxy">
                </div>
                <div class="setting-item">
                    <label>ä¾§è¾¹æ å›¾æ ‡ (Emoji)</label>
                    <div class="input-with-btn">
                        <input type="text" id="sidebar-icon-input" value="ğŸ’¬" maxlength="2" placeholder="è¾“å…¥ emoji">
                    </div>
                </div>
            </div>
            <!-- Features -->
            <div class="setting-group">
                <h3>æ˜Ÿè¯­è®¾ç½®</h3>
                <div class="setting-item checkbox-row">
                    <input type="checkbox" id="show-subtitles" checked>
                    <label for="show-subtitles">å¼€å¯æ˜Ÿè¯­ (æ¼«æ¸¸å­—å¹•)</label>
                </div>
                <div class="setting-item checkbox-row">
                    <input type="checkbox" id="loop-subtitles">
                    <label for="loop-subtitles">å¾ªç¯æ’­æ”¾ (åŒä¸€æ˜Ÿçƒå¤šå¥å›å¿†)</label>
                </div>
                <div class="setting-item">
                    <label>å•å¥åœç•™æ—¶é—´ <span id="subtitle-duration-val">8s</span></label>
                    <input type="range" id="subtitle-duration" min="3" max="15" value="8">
                </div>
                <div class="setting-item">
                    <label>æ·¡å…¥æ—¶é—´ <span id="subtitle-fadein-val">1.0s</span></label>
                    <input type="range" id="subtitle-fadein" min="0.1" max="3.0" step="0.1" value="1.0">
                </div>
                <div class="setting-item">
                    <label>æ·¡å‡ºæ—¶é—´ <span id="subtitle-fadeout-val">1.0s</span></label>
                    <input type="range" id="subtitle-fadeout" min="0.1" max="3.0" step="0.1" value="1.0">
                </div>
            </div>
            <!-- Animation -->
            <div class="setting-group">
                <h3>åŠ¨ç”»è®¾ç½®</h3>
                <div class="setting-item">
                    <label>æ¼«æ¸¸é€Ÿåº¦ (ç§’/è·³) <span id="roam-speed-val">12s</span></label>
                    <input type="range" id="roam-speed" min="4" max="20" value="12">
                </div>
                <div class="setting-item">
                    <label>åŸºç¡€è‡ªè½¬é€Ÿåº¦ <span id="rotate-speed-val">0.4</span></label>
                    <input type="range" id="rotate-speed" min="0" max="2" step="0.1" value="0.4">
                </div>
                <div class="setting-item checkbox-row">
                    <input type="checkbox" id="idle-rotation-enabled" checked>
                    <label for="idle-rotation-enabled">å¼€å¯é—²ç½®è‡ªåŠ¨æ¼«æ¸¸</label>
                </div>
                <div class="setting-item">
                    <label>é—²ç½®è‡ªåŠ¨æ¼«æ¸¸æ£€æµ‹ (ç§’) <span id="idle-time-val">10s</span></label>
                    <input type="range" id="idle-time" min="5" max="60" value="10">
                </div>
                <div class="setting-item">
                    <label>é—²ç½®æ¼«æ¸¸é€Ÿåº¦ <span id="idle-speed-val">0.2</span></label>
                    <input type="range" id="idle-speed" min="0.1" max="2.0" step="0.1" value="0.2">
                </div>
            </div>
            <!-- Interaction -->
            <div class="setting-group">
                <h3>äº¤äº’è®¾ç½®</h3>
                <div class="setting-item checkbox-row">
                    <input type="checkbox" id="hover-highlight-enabled">
                    <label for="hover-highlight-enabled">å¼€å¯é¼ æ ‡æ‚¬åœé«˜äº®</label>
                </div>
                <div class="setting-item">
                    <label>ç‚¹å‡»é«˜äº®æŒç»­æ—¶é—´ (ç§’) <span id="highlight-duration-val">5s</span></label>
                    <input type="range" id="highlight-duration" min="0" max="20" step="1" value="5">
                    <div style="font-size: 10px; color: #999; margin-top: 2px;">0 è¡¨ç¤ºæ— é™æŒç»­</div>
                </div>
                <div class="setting-item">
                    <label>è¿çº¿ä¸é€æ˜åº¦ <span id="link-opacity-val">0.05</span></label>
                    <input type="range" id="link-opacity" min="0.01" max="1.0" step="0.01" value="0.05">
                </div>
                <div class="setting-item">
                    <label>è¿çº¿ç²—ç»† <span id="link-width-val">0.2</span></label>
                    <input type="range" id="link-width" min="0.05" max="3.0" step="0.05" value="0.2">
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Load Data -->
<script src="js/config.js" defer></script>
<script src="js/logger.js" defer></script>
<script src="js/log-wrapper.js" defer></script>
<script src="js/error-handler.js" defer></script>
<script src="js/data-loader.js" defer></script>
<!-- data.js å’Œ insights.js å°†ç”± data-loader.js æŒ‰éœ€åŠ¨æ€åŠ è½½ -->
<!-- å·²åºŸå¼ƒ: datasets.js åŠŸèƒ½å·²è¢« DatasetManagerV3 (data-manager.js) å®Œå…¨æ›¿ä»£ -->
<script src="js/data-manager.js" defer></script>
<script src="js/data-import.js" defer></script>
<script src="js/processors/text-processor.js" defer></script>
<!-- UI Components -->
<script src="js/ui/draggable-button.js" defer></script>
<script src="js/app.js" defer></script>

<!-- Unified Sidebar -->
<button class="sidebar-toggle" onclick="toggleSidebar()">
    <i class="ri-apps-2-line"></i>
</button>

<div class="sidebar-overlay" onclick="closeSidebar()"></div>

<aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <h2><i class="ri-planet-line"></i> ChatGalaxy</h2>
        <button class="sidebar-close" onclick="closeSidebar()">
            <i class="ri-close-line"></i>
        </button>
    </div>

    <div class="sidebar-content">
        <!-- 3Dæ§åˆ¶ -->
        <div class="sidebar-section">
            <div class="sidebar-section-title">3Dæ§åˆ¶</div>
            <div class="sidebar-grid">
                <button class="sidebar-btn" onclick="startRoaming()" title="ç¬¬ä¸€äººç§°æ¼«æ¸¸">
                    <i class="ri-flight-takeoff-line"></i>
                    <span>æ¼«æ¸¸</span>
                </button>
                <button class="sidebar-btn" onclick="takePolaroid()" title="æ‹ç«‹å¾—ç•™å¿µ">
                    <i class="ri-camera-lens-line"></i>
                    <span>æ‹ç…§</span>
                </button>
                <button class="sidebar-btn" id="coalesce-btn" onclick="coalesceNodes()" title="å‡èšå›å¿†">
                    <i class="ri-contract-left-line"></i>
                    <span>å‡èš</span>
                </button>
                <button class="sidebar-btn" onclick="toggleTimeTravelPlay()" title="æ’­æ”¾å›å¿†">
                    <i class="ri-play-fill"></i>
                    <span>æ’­æ”¾</span>
                </button>
            </div>
        </div>

        <!-- åŠŸèƒ½æ§åˆ¶ -->
        <div class="sidebar-section">
            <div class="sidebar-section-title">åŠŸèƒ½æ§åˆ¶</div>
            <div class="sidebar-list">
                <div class="sidebar-item" onclick="startRevisitMode()" title="å›è®¿æ¨¡å¼ - è·³è½¬åˆ°éšæœºèŠ‚ç‚¹">
                    <i class="ri-flight-land-line"></i>
                    <span>å›è®¿æ¨¡å¼</span>
                </div>
                <div class="sidebar-item" onclick="initSettings(true)" title="æ‰“å¼€è®¾ç½®é¢æ¿">
                    <i class="ri-settings-3-line"></i>
                    <span>è®¾ç½®</span>
                </div>
            </div>
        </div>

        <!-- æ•°æ®åˆ†æ -->
        <div class="sidebar-section">
            <div class="sidebar-section-title">æ•°æ®åˆ†æ</div>
            <div class="sidebar-list">
                <div class="sidebar-item" onclick="showInsights()">
                    <i class="ri-lightbulb-flash-line"></i>
                    <span>æ´å¯ŸæŠ¥å‘Š</span>
                </div>
                <div class="sidebar-item" onclick="showDataManager()">
                    <i class="ri-database-2-line"></i>
                    <span>æ•°æ®ç®¡ç†</span>
                </div>
            </div>
        </div>

        <!-- æ˜Ÿç³»åˆ†å¸ƒ -->
        <div class="sidebar-section">
            <div class="sidebar-section-title">æ˜Ÿç³»åˆ†å¸ƒ</div>
            <div class="sidebar-grid">
                <button class="sidebar-btn" id="layout-sphere-btn" title="çƒä½“åˆ†å¸ƒ">
                    <i class="ri-planet-line"></i>
                    <span>çƒä½“</span>
                </button>
                <button class="sidebar-btn" id="layout-flower-btn" title="èŠ±æœµåˆ†å¸ƒ">
                    <i class="ri-plant-line"></i>
                    <span>èŠ±æœµ</span>
                </button>
                <button class="sidebar-btn" id="layout-helix-btn" title="èºæ—‹åˆ†å¸ƒ">
                    <i class="ri-tornado-line"></i>
                    <span>èºæ—‹</span>
                </button>
                <button class="sidebar-btn" id="layout-grid-btn" title="ç«‹æ–¹åˆ†å¸ƒ">
                    <i class="ri-grid-line"></i>
                    <span>ç«‹æ–¹</span>
                </button>
                <button class="sidebar-btn" id="layout-torus-btn" title="ç¯é¢åˆ†å¸ƒ">
                    <i class="ri-donut-chart-line"></i>
                    <span>ç¯é¢</span>
                </button>
                <button class="sidebar-btn" id="layout-reset-btn" title="ç‰©ç†é‡ç½®">
                    <i class="ri-refresh-line"></i>
                    <span>é‡ç½®</span>
                </button>
                <button class="sidebar-btn" id="layout-export-btn" title="å¯¼å‡ºåˆ†å¸ƒ">
                    <i class="ri-download-line"></i>
                    <span>å¯¼å‡º</span>
                </button>
                <button class="sidebar-btn" id="layout-import-btn" title="å¯¼å…¥æ¨¡æ¿">
                    <i class="ri-upload-line"></i>
                    <span>å¯¼å…¥</span>
                </button>
            </div>
            <input type="file" id="layout-file-input" style="display: none;" accept=".json">
        </div>

        <!-- å¤–è§‚è®¾ç½® -->
        <div class="sidebar-section">
            <div class="sidebar-section-title">å¤–è§‚è®¾ç½®</div>

            <!-- ä¸»é¢˜é€‰æ‹©å™¨ -->
            <div id="theme-selector" class="theme-selector"></div>

            <!-- é€æ˜åº¦æ»‘å— -->
            <div id="transparency-slider-container" class="transparency-wrapper"></div>
        </div>

        <!-- è§†å›¾è®¾ç½® -->
        <div class="sidebar-section">
            <div class="sidebar-section-title">è§†å›¾è®¾ç½®</div>
            <div class="sidebar-switch">
                <div class="switch-label">
                    <i class="ri-music-2-line"></i>
                    <span>æ°›å›´éŸ³æ•ˆ</span>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="music-toggle" checked onchange="toggleMusic()">
                    <span class="toggle-slider"></span>
                </label>
            </div>
        </div>
    </div>

    <div class="sidebar-footer">
        <div class="sidebar-info">
            <strong>ChatGalaxy</strong>
            æ·±å±±æœ‰å¯†æ—å›¢é˜Ÿ Â© 2026
        </div>
    </div>
</aside>

<!-- Web Vitals æ€§èƒ½ç›‘æ§ -->
<script>
(function() {
  if ('PerformanceObserver' in window) {
    // ç›‘æ§ Largest Contentful Paint (LCP)
    const lcpObserver = new PerformanceObserver((list) => {
      for (const entry of list.getEntries()) {
        console.log('[Web Vitals] LCP:', Math.round(entry.startTime), 'ms');
        // å¯é€‰ï¼šå‘é€åˆ°åˆ†ææœåŠ¡
        // navigator.sendBeacon('/api/analytics', JSON.stringify({
        //   metric: 'LCP',
        //   value: entry.startTime
        // }));
      }
    });
    lcpObserver.observe({ entryTypes: ['largest-contentful-paint'] });

    // ç›‘æ§ First Input Delay (FID)
    const fidObserver = new PerformanceObserver((list) => {
      for (const entry of list.getEntries()) {
        console.log('[Web Vitals] FID:', Math.round(entry.processingStart - entry.startTime), 'ms');
      }
    });
    fidObserver.observe({ entryTypes: ['first-input'] });

    // ç›‘æ§ Cumulative Layout Shift (CLS)
    let clsScore = 0;
    const clsObserver = new PerformanceObserver((list) => {
      for (const entry of list.getEntries()) {
        if (!entry.hadRecentInput) {
          clsScore += entry.value;
          console.log('[Web Vitals] CLS:', clsScore.toFixed(3));
        }
      }
    });
    clsObserver.observe({ entryTypes: ['layout-shift'] });

    // ç›‘æ§ First Contentful Paint (FCP)
    const fcpObserver = new PerformanceObserver((list) => {
      for (const entry of list.getEntries()) {
        if (entry.name === 'first-contentful-paint') {
          console.log('[Web Vitals] FCP:', Math.round(entry.startTime), 'ms');
        }
      }
    });
    fcpObserver.observe({ entryTypes: ['paint'] });

    console.log('[Web Vitals] ç›‘æ§å·²å¯åŠ¨');
  } else {
    console.warn('[Web Vitals] æµè§ˆå™¨ä¸æ”¯æŒ PerformanceObserver');
  }

  // ç›‘æ§èµ„æºåŠ è½½æ—¶é—´
  window.addEventListener('load', () => {
    setTimeout(() => {
      const perfData = performance.getEntriesByType('navigation')[0];
      if (perfData) {
        console.log('[Performance] é¡µé¢åŠ è½½æ€§èƒ½:', {
          DNSæŸ¥è¯¢: Math.round(perfData.domainLookupEnd - perfData.domainLookupStart) + 'ms',
          TCPè¿æ¥: Math.round(perfData.connectEnd - perfData.connectStart) + 'ms',
          è¯·æ±‚å“åº”: Math.round(perfData.responseEnd - perfData.requestStart) + 'ms',
          DOMè§£æ: Math.round(perfData.domContentLoadedEventEnd - perfData.domInteractive) + 'ms',
          æ€»åŠ è½½æ—¶é—´: Math.round(perfData.loadEventEnd - perfData.fetchStart) + 'ms'
        });
      }
    }, 0);
  });
})();
</script>

<script>
// ==================== ä¾§è¾¹æ æ§åˆ¶ ====================
let isSidebarOpen = false;
let isMessageSidebarCollapsed = false;

// å·¦ä¾§æ¶ˆæ¯åˆ—è¡¨ä¾§è¾¹æ æŠ˜å /å±•å¼€
function toggleMessageSidebar() {
    const sidebar = document.getElementById('message-sidebar');
    if (!sidebar) return;

    isMessageSidebarCollapsed = !isMessageSidebarCollapsed;

    if (isMessageSidebarCollapsed) {
        sidebar.classList.add('collapsed');
        document.body.classList.add('message-sidebar-collapsed');
    } else {
        sidebar.classList.remove('collapsed');
        document.body.classList.remove('message-sidebar-collapsed');
    }

    console.log(`ğŸ“‚ ${isMessageSidebarCollapsed ? 'æŠ˜å ' : 'å±•å¼€'}å·¦ä¾§ä¾§è¾¹æ `);
}

// åˆå§‹åŒ–å·¦ä¾§ä¾§è¾¹æ æŠ˜å æŒ‰é’®
document.addEventListener('DOMContentLoaded', () => {
    const collapseBtn = document.getElementById('message-sidebar-toggle');
    const fixedToggleBtn = document.getElementById('message-sidebar-toggle-fixed');

    if (collapseBtn) {
        collapseBtn.addEventListener('click', toggleMessageSidebar);
    }

    if (fixedToggleBtn) {
        fixedToggleBtn.addEventListener('click', toggleMessageSidebar);
    }
});

function toggleSidebar() {
    console.log('ğŸ”„ [DEBUG] toggleSidebar called');

    // ğŸ”§ å¼ºåˆ¶éšè—æ‰€æœ‰è¦†ç›–å±‚ï¼Œç¡®ä¿ä¾§è¾¹æ ä¸è¢«é®æŒ¡
    const overlays = document.querySelectorAll('.experience-overlay, #loading');
    overlays.forEach(overlay => {
        if (overlay.classList.contains('visible')) {
            overlay.classList.remove('visible');
            overlay.classList.add('hidden', 'fade-out');
            overlay.style.display = 'none';
            console.log('âœ… [DEBUG] Hidden overlay:', overlay.id);
        }
    });

    const sidebar = document.getElementById('sidebar');
    const overlay = document.querySelector('.sidebar-overlay');

    if (!sidebar) {
        console.error('âŒ [DEBUG] Sidebar element not found!');
        return;
    }

    // ğŸ”§ åŒæ­¥çŠ¶æ€ï¼šæ ¹æ®ä¾§è¾¹æ å®é™…DOMçŠ¶æ€æ›´æ–° isSidebarOpen
    const actuallyOpen = sidebar.classList.contains('active');
    if (actuallyOpen !== isSidebarOpen) {
        console.log('âš ï¸ [DEBUG] State mismatch detected! Syncing...');
        isSidebarOpen = actuallyOpen;
    }

    console.log('ğŸ“Š [DEBUG] Before toggle:', {
        isSidebarOpen: isSidebarOpen,
        actuallyOpen: actuallyOpen,
        sidebarClasses: sidebar.className,
        sidebarRight: window.getComputedStyle(sidebar).right
    });

    isSidebarOpen = !isSidebarOpen;
    sidebar.classList.toggle('active', isSidebarOpen);
    overlay.classList.toggle('active', isSidebarOpen);

    // ğŸ”§ æ˜¾ç¤º/éšè—åŠŸèƒ½æŒ‰é’®
    const toggleBtn = document.querySelector('.sidebar-toggle');
    if (toggleBtn) {
        toggleBtn.style.display = isSidebarOpen ? 'none' : 'flex';
    }

    // ğŸ”§ å¼ºåˆ¶è®¾ç½®æ ·å¼ç¡®ä¿å¯è§
    if (isSidebarOpen) {
        sidebar.style.position = 'fixed';
        sidebar.style.right = '0';
        sidebar.style.display = 'block';
        sidebar.style.visibility = 'visible';
        sidebar.style.opacity = '1';
        // ğŸ”§ ä¸å†è®¾ç½® backgroundï¼Œä½¿ç”¨ CSS å˜é‡ --sidebar-bg
        console.log('âœ… [DEBUG] Sidebar opened');
    } else {
        sidebar.style.right = '-280px'; // ğŸ”´ ä¿®å¤ï¼šå…³é—­æ—¶ç§»åˆ°å³ä¾§å¤–éƒ¨
        sidebar.style.border = 'none';
        console.log('âœ… [DEBUG] Sidebar closed');
    }

    console.log('ğŸ“Š [DEBUG] After toggle:', {
        isSidebarOpen: isSidebarOpen,
        sidebarClasses: sidebar.className,
        sidebarRight: window.getComputedStyle(sidebar).right,
        sidebarBackground: window.getComputedStyle(sidebar).background
    });
}

function closeSidebar() {
    console.log('ğŸ”’ [DEBUG] closeSidebar called');
    const sidebar = document.getElementById('sidebar');
    const overlay = document.querySelector('.sidebar-overlay');

    if (!sidebar) {
        console.error('âŒ [DEBUG] Sidebar element not found!');
        return;
    }

    isSidebarOpen = false;
    sidebar.classList.remove('active');
    overlay.classList.remove('active');

    // ğŸ”§ æ˜¾ç¤ºåŠŸèƒ½æŒ‰é’®
    const toggleBtn = document.querySelector('.sidebar-toggle');
    if (toggleBtn) {
        toggleBtn.style.display = 'flex';
    }

    // ğŸ”§ å¼ºåˆ¶è®¾ç½®æ ·å¼ç¡®ä¿ä¾§è¾¹æ éšè—
    sidebar.style.right = '-280px';
    sidebar.style.border = 'none';

    console.log('âœ… [DEBUG] Sidebar closed via closeSidebar()');
}

// ==================== åŠŸèƒ½å¯¼èˆª ====================
function showInsights() {
    // ç›´æ¥è·³è½¬åˆ°æ´å¯ŸæŠ¥å‘Šé¡µé¢ï¼ˆå’Œæ•°æ®ç®¡ç†å™¨ä¸€æ ·ï¼‰
    window.location.href = 'insights.html';
}

function showDataManager() {
    // è·³è½¬åˆ°ç‹¬ç«‹çš„æ•°æ®ç®¡ç†å™¨é¡µé¢
    window.location.href = 'data-manager.html';
}

// ==================== ESCé”®å…³é—­ä¾§è¾¹æ  ====================
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        if (isSidebarOpen) {
            closeSidebar();
        }
    }
});
</script>

<!-- ğŸ†• ä¸»é¢˜ç³»ç»Ÿ JavaScript -->
<script type="module">
    import { autoMigrateAndApply } from './js/theme/migration.js';
    import { getMessageSidebar } from './js/ui/left-sidebar.js';
    import { getSettingsSidebar } from './js/ui/right-sidebar.js';
    import { createThemeSelector } from './js/ui/theme-selector.js';
    import { createTransparencySlider } from './js/ui/transparency-slider.js';
    // initDraggableButton å·²é€šè¿‡å…¨å±€å˜é‡æä¾›ï¼ˆåœ¨ draggable-button.js ä¸­å¯¼å‡ºï¼‰

    // ç­‰å¾… DOM åŠ è½½å®Œæˆ
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initThemeSystem);
    } else {
        initThemeSystem();
    }

    function initThemeSystem() {

        // 1. è‡ªåŠ¨è¿ç§»æ—§è®¾ç½®å¹¶åˆå§‹åŒ–ä¸»é¢˜
        autoMigrateAndApply();

        // 2. ğŸ”§ åˆå§‹åŒ–å¯æ‹–åŠ¨æŒ‰é’®
        try {
            initDraggableButton('.sidebar-toggle', {
                snapEdge: 'right',      // è´´åˆ°å³ä¾§
                snapThreshold: 50,      // è´´è¾¹é˜ˆå€¼
                edgePadding: 20         // è¾¹ç¼˜å†…è¾¹è·
            });
            console.log('âœ… [index.html] Draggable button initialized');
        } catch (error) {
            console.error('âŒ [index.html] Failed to initialize draggable button:', error);
        }

        // 3. åˆå§‹åŒ–ä¸»é¢˜é€‰æ‹©å™¨
        try {
            createThemeSelector({
                containerId: 'theme-selector',
                showPreview: true
            });
        } catch (error) {
            console.warn('âš ï¸ [index.html] Theme selector initialization skipped:', error);
        }

        // 3. åˆå§‹åŒ–é€æ˜åº¦æ»‘å—
        try {
            createTransparencySlider({
                containerId: 'transparency-slider-container',
                min: 50,
                max: 100,
                step: 5,
                showValue: true
            });
        } catch (error) {
            console.warn('âš ï¸ [index.html] Transparency slider initialization skipped:', error);
        }

        // 4. åˆå§‹åŒ–ä¾§è¾¹æ ï¼ˆå¦‚æœéœ€è¦ï¼‰
        try {
            window.MessageSidebar = getMessageSidebar();
            window.SettingsSidebar = getSettingsSidebar();
        } catch (error) {
            console.warn('âš ï¸ [index.html] Sidebar initialization skipped:', error);
        }

        // 5. ç›‘å¬ä¸»é¢˜å˜æ›´äº‹ä»¶
        if (window.ThemeManager) {
            window.ThemeManager.on('themeChange', (data) => {

                // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ ä¸»é¢˜å˜æ›´åçš„é¢å¤–å¤„ç†
                // ä¾‹å¦‚æ›´æ–°3Då›¾å½¢é¢œè‰²ã€åˆ·æ–°ç²’å­æ•ˆæœç­‰
            });
        }
    }
</script>

</body>
</html>
